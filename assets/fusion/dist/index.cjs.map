{"version":3,"file":"index.cjs","sources":["../src/utilities/arr.ts","../src/processors/css.ts","../src/processors/js.ts","../src/processors/move.ts","../src/processors/copy.ts","../src/processors/link.ts","../src/processors/callback.ts","../src/params.ts","../src/utilities/env.ts","../src/utilities/crypto.ts","../src/utilities/fs.ts","../src/builder/BuildTask.ts","../src/utilities/utilities.ts","../src/builder/ConfigBuilder.ts","../src/runner/app.ts","../src/runner/config.ts","../src/runner/describe.ts","../src/runner/tasks.ts","../src/index.ts"],"sourcesContent":["import { MaybeArray } from 'rollup';\r\n\r\nexport function forceArray<T>(item: T | T[]): T[] {\r\n  if (Array.isArray(item)) {\r\n    return item;\r\n  } else {\r\n    return [item];\r\n  }\r\n}\r\n\r\nexport function handleMaybeArray<T, R>(\r\n  items: T | T[],\r\n  callback: (item: T) => R\r\n): T extends any[] ? R[] : R {\r\n  if (Array.isArray(items)) {\r\n    return items.map(callback) as any;\r\n  } else {\r\n    return callback(items as T) as any;\r\n  }\r\n}\r\n\r\nexport function handleForceArray<T, R>(\r\n  items: T | T[],\r\n  callback: (item: T) => R\r\n): R[] {\r\n  items = forceArray(items);\r\n\r\n  return items.map(callback) as any;\r\n}\r\n\r\nexport function appendToMaybeArray<T>(items: MaybeArray<T>, value: T): T[] {\r\n  if (Array.isArray(items)) {\r\n    items.push(value);\r\n\r\n    return items;\r\n  } else {\r\n    return [items, value];\r\n  }\r\n}\r\n","import BuildTask from '@/builder/BuildTask.ts';\r\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface';\r\nimport { CssOptions, TaskInput, TaskOutput } from '@/types';\r\nimport { forceArray, handleForceArray, handleMaybeArray } from '@/utilities/arr';\r\nimport { basename, parse } from 'node:path';\r\nimport { MaybePromise } from '@/types';\r\n\r\nexport function css(\r\n  input: TaskInput,\r\n  output?: TaskOutput,\r\n  options: CssOptions = {}\r\n): CssProcessor {\r\n  return new CssProcessor(input, output, options);\r\n}\r\n\r\nexport class CssProcessor implements ProcessorInterface {\r\n  constructor(protected input: TaskInput, protected output?: TaskOutput, protected options: CssOptions = {}) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): BuildTask[] {\r\n    return handleForceArray(this.input, (input) => {\r\n      const task = builder.addTask(input, taskName);\r\n\r\n      builder.assetFileNamesCallbacks.push((assetInfo) => {\r\n        const name = assetInfo.names[0];\r\n\r\n        if (!name) {\r\n          return undefined;\r\n        }\r\n\r\n        // Rename only if the asset name matches the task id with .css extension\r\n        if (basename(name, '.css') === task.id) {\r\n          if (!this.output) {\r\n            return parse(input).name + '.css';\r\n          }\r\n\r\n          return task.normalizeOutput(this.output, '.css');\r\n\r\n          // if (!isAbsolute(name)) {\r\n          //   return name;\r\n          // } else {\r\n          //   builder.moveFilesMap[task.id + '.css'] = name;\r\n          // }\r\n        }\r\n      });\r\n\r\n      return task;\r\n    });\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return forceArray(this.input).map((input) => {\r\n      return {\r\n        input,\r\n        output: this.output || basename(input),\r\n        extra: {}\r\n      };\r\n    });\r\n  }\r\n}\r\n","import BuildTask from '@/builder/BuildTask.ts';\r\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { TaskInput, TaskOutput } from '@/types';\r\nimport { forceArray, handleForceArray, handleMaybeArray } from '@/utilities/arr';\r\nimport { basename, parse } from 'node:path';\r\nimport { MaybePromise } from '@/types';\r\n\r\nexport function js(input: TaskInput, output?: TaskOutput): ProcessorInterface {\r\n  return new JsProcessor(input, output);\r\n}\r\n\r\nexport class JsProcessor implements ProcessorInterface {\r\n\r\n  constructor(public input: TaskInput, public output?: TaskOutput) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): BuildTask[] {\r\n    return handleForceArray(this.input, (input) => {\r\n      const task = builder.addTask(input, taskName);\r\n\r\n      builder.entryFileNamesCallbacks.push((chunkInfo) => {\r\n        const name = chunkInfo.name;\r\n\r\n        if (!name) {\r\n          return;\r\n        }\r\n\r\n        // Rename only if the asset name matches the task id with .css extension\r\n        if (name === task.id) {\r\n          if (!this.output) {\r\n            return parse(input).name + '.js';\r\n          }\r\n\r\n          return task.normalizeOutput(this.output);\r\n\r\n          // if (!isAbsolute(name)) {\r\n          //   return name;\r\n          // } else {\r\n          //   builder.moveFilesMap[task.id + '.css'] = name;\r\n          // }\r\n        }\r\n      });\r\n\r\n      return task;\r\n    });\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return forceArray(this.input).map((input) => {\r\n      return {\r\n        input,\r\n        output: this.output || basename(input),\r\n        extra: {}\r\n      };\r\n    });\r\n  }\r\n}\r\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { TaskInput } from '@/types';\r\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\r\nimport { MaybePromise } from '@/types';\r\nimport { types } from 'sass';\r\n\r\nexport function move(input: TaskInput, dest: string) {\r\n  return new MoveProcessor(input, dest);\r\n}\r\n\r\nexport class MoveProcessor implements ProcessorInterface {\r\n  constructor(public input: TaskInput, public dest: string) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\r\n    handleMaybeArray(this.input, (input) => {\r\n      builder.moveTasks.push({ src: input, dest: this.dest, options: {} });\r\n    });\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return forceArray(this.input).map((input) => {\r\n      return {\r\n        input,\r\n        output: this.dest,\r\n        extra: {}\r\n      };\r\n    });\r\n  }\r\n}\r\n\r\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { TaskInput } from '@/types';\r\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\r\nimport { MaybePromise } from '@/types';\r\n\r\nexport function copy(input: TaskInput, dest: string) {\r\n  return new CopyProcessor(input, dest);\r\n}\r\n\r\nexport class CopyProcessor implements ProcessorInterface {\r\n  constructor(public input: TaskInput, public dest: string) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\r\n    handleMaybeArray(this.input, (input) => {\r\n      builder.copyTasks.push({ src: input, dest: this.dest, options: {} })\r\n    });\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return forceArray(this.input).map((input) => {\r\n      return {\r\n        input,\r\n        output: this.dest,\r\n        extra: {}\r\n      };\r\n    });\r\n  }\r\n}\r\n\r\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { LinkOptions, TaskInput } from '@/types';\r\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\r\nimport { MaybePromise } from '@/types';\r\n\r\nexport function link(input: TaskInput, dest: string, options: LinkOptions = {}) {\r\n  return new LinkProcessor(input, dest, options);\r\n}\r\n\r\nexport class LinkProcessor implements ProcessorInterface {\r\n  constructor(public input: TaskInput, public dest: string, public options: LinkOptions = {}) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\r\n    handleMaybeArray(this.input, (input) => {\r\n      builder.linkTasks.push({ src: input, dest: this.dest, options: this.options });\r\n    });\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return forceArray(this.input).map((input) => {\r\n      return {\r\n        input,\r\n        output: this.dest,\r\n        extra: {}\r\n      };\r\n    });\r\n  }\r\n}\r\n\r\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { MaybePromise } from '@/types';\r\n\r\ntype CallbackHandler = (taskName: string, builder: ConfigBuilder) => MaybePromise<any>;\r\n\r\nexport function callback(handler: CallbackHandler) {\r\n  return new CallbackProcessor(handler);\r\n}\r\n\r\nexport function callbackAfterBuild(handler: CallbackHandler) {\r\n  return new CallbackProcessor(handler, true);\r\n}\r\n\r\nclass CallbackProcessor implements ProcessorInterface {\r\n  constructor(\r\n    /** @internal */\r\n    private handler: CallbackHandler,\r\n    /** @internal */\r\n    private afterBuild = false\r\n  ) {\r\n  }\r\n\r\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<any> {\r\n    if (this.afterBuild) {\r\n      builder.postBuildCallbacks.push(() => this.handler(taskName, builder));\r\n    } else {\r\n      this.handler(taskName, builder);\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  preview(): MaybePromise<ProcessorPreview[]> {\r\n    return [];\r\n  }\r\n}\r\n\r\n","import { RunnerCliParams } from '@/types';\r\n\r\nlet params: RunnerCliParams | undefined = undefined;\r\n\r\nexport function prepareParams(p: RunnerCliParams): RunnerCliParams {\r\n  params = p;\r\n\r\n  isVerbose = params?.verbose ? params?.verbose > 0 : false;\r\n\r\n  return p;\r\n}\r\n\r\nlet isVerbose = false;\r\nconst isProd = process.env.NODE_ENV === 'production';\r\nconst isDev = !isProd;\r\n\r\nexport { isVerbose, isDev, isProd, params };\r\n","export function isWindows() {\r\n  return process.platform === 'win32';\r\n}\r\n","import Crypto from 'crypto';\r\n\r\nexport function shortHash(bufferOrString: Crypto.BinaryLike, short: number | null = 8): string {\r\n  let hash = Crypto.createHash('sha1')\r\n    .update(bufferOrString)\r\n    .digest('hex');\r\n\r\n  if (short && short > 0) {\r\n    hash = hash.substring(0, short);\r\n  }\r\n\r\n  return hash;\r\n}\r\n\r\n\r\n","import { FileTasks } from '@/types';\r\nimport { isWindows } from '@/utilities/env.ts';\r\nimport { shortHash } from '@/utilities/crypto.ts';\r\nimport fg from 'fast-glob';\r\nimport fs from 'fs-extra';\r\nimport { randomBytes } from 'node:crypto';\r\nimport { dirname, isAbsolute, normalize, relative, resolve } from 'node:path';\r\nimport { Logger } from 'vite';\r\n\r\nfunction handleFilesOperation(\r\n  src: string,\r\n  dest: string,\r\n  options: {\r\n    outDir: string;\r\n    handler: (src: string, dest: string) => Promise<any>;\r\n    globOptions?: fg.Options;\r\n  }\r\n) {\r\n  const promises = [];\r\n  src = normalizeFilePath(src, options.outDir);\r\n  dest = normalizeFilePath(dest, options.outDir);\r\n\r\n  const base = getGlobBaseFromPattern(src);\r\n  const sources = isGlob(src)\r\n    ? fg.globSync(src.replace(/\\\\/g, '/'), options.globOptions)\r\n    : [src];\r\n\r\n  for (let source of sources) {\r\n    let dir;\r\n    let resolvedDest = dest;\r\n\r\n    if (endsWithSlash(dest)) {\r\n      dir = resolvedDest;\r\n      resolvedDest = resolvedDest + relative(base, source);\r\n    } else {\r\n      dir = dirname(resolvedDest);\r\n    }\r\n\r\n    fs.ensureDirSync(dir);\r\n\r\n    promises.push(options.handler(source, resolvedDest));\r\n  }\r\n\r\n  return promises;\r\n}\r\n\r\nexport function moveFilesAndLog(tasks: FileTasks, outDir: string, logger: Logger) {\r\n  const promises = [];\r\n\r\n  for (const { src, dest, options } of tasks) {\r\n    const ps = handleFilesOperation(\r\n      src,\r\n      dest,\r\n      {\r\n        outDir,\r\n        handler: async (src, dest) => {\r\n          logger.info(`Moving file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\r\n          return fs.move(src, dest, { overwrite: true });\r\n        },\r\n        globOptions: { onlyFiles: true }\r\n      }\r\n    );\r\n\r\n    promises.push(...ps);\r\n  }\r\n\r\n  return Promise.all(promises);\r\n}\r\n\r\nexport function copyFilesAndLog(tasks: FileTasks, outDir: string, logger: Logger) {\r\n  const promises = [];\r\n\r\n  for (const { src, dest, options } of tasks) {\r\n    const ps = handleFilesOperation(\r\n      src,\r\n      dest, {\r\n        outDir,\r\n        handler: async (src, dest) => {\r\n          logger.info(`Copy file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\r\n          return fs.copy(src, dest, { overwrite: true });\r\n        },\r\n        globOptions: { onlyFiles: true }\r\n      }\r\n    );\r\n\r\n    promises.push(...ps);\r\n  }\r\n\r\n  return Promise.all(promises);\r\n}\r\n\r\nexport function linkFilesAndLog(tasks: FileTasks<'link'>, outDir: string, logger: Logger) {\r\n  const promises = [];\r\n\r\n  for (const { src, dest, options } of tasks) {\r\n    const ps = handleFilesOperation(\r\n      src,\r\n      dest, {\r\n        outDir,\r\n        handler: async (src, dest) => {\r\n          logger.info(`Link file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\r\n          return symlink(src, dest, options?.force ?? false);\r\n        },\r\n        globOptions: { onlyFiles: false }\r\n      }\r\n    );\r\n\r\n    promises.push(...ps);\r\n  }\r\n\r\n  return Promise.all(promises);\r\n}\r\n\r\nexport function cleanFiles(patterns: string[], outDir: string) {\r\n  const promises = [];\r\n\r\n  outDir = outDir.replace(/\\\\/g, '/');\r\n\r\n  for (let src of patterns) {\r\n    src = normalizeFilePath(src, outDir);\r\n    src = resolve(src);\r\n    \r\n    const sources = isGlob(src)\r\n      ? fg.globSync(src.replace(/\\\\/g, '/'), { onlyFiles: false })\r\n      : [src];\r\n\r\n    // To protect `upload/*` folder.\r\n    const protectDir = resolve(outDir + '/upload').replace(/\\\\/g, '/');\r\n\r\n    for (let source of sources) {\r\n      if (source.replace(/\\\\/g, '/').startsWith(protectDir)) {\r\n        throw new Error('Refuse to delete `upload/*` folder.');\r\n      }\r\n\r\n      promises.push(fs.remove(source));\r\n    }\r\n  }\r\n\r\n  return Promise.all(promises);\r\n}\r\n\r\nexport async function copyGlob(src: string, dest: string): Promise<void> {\r\n  const promises = handleFilesOperation(\r\n    src,\r\n    dest,\r\n    {\r\n      outDir: process.cwd(),\r\n      handler: async (src, dest) => fs.copy(src, dest, { overwrite: true }),\r\n      globOptions: { onlyFiles: true }\r\n    }\r\n  );\r\n\r\n  await Promise.all(promises);\r\n}\r\n\r\nexport async function moveGlob(src: string, dest: string): Promise<void> {\r\n  const promises = handleFilesOperation(\r\n    src,\r\n    dest,\r\n    {\r\n      outDir: process.cwd(),\r\n      handler: async (src, dest) => fs.move(src, dest, { overwrite: true }),\r\n      globOptions: { onlyFiles: true }\r\n    }\r\n  );\r\n\r\n  await Promise.all(promises);\r\n}\r\n\r\nexport async function symlink(target: string, link: string, force = false) {\r\n  if (isWindows() && !fs.lstatSync(target).isFile()) {\r\n    return fs.ensureSymlink(target, link, 'junction');\r\n  }\r\n\r\n  if (isWindows() && fs.lstatSync(target).isFile() && force) {\r\n    return fs.ensureLink(target, link);\r\n  }\r\n\r\n  return fs.ensureSymlink(target, link);\r\n}\r\n\r\nexport function endsWithSlash(path: string): boolean {\r\n  return path.endsWith('/') || path.endsWith('\\\\');\r\n}\r\n\r\nexport function getGlobBaseFromPattern(pattern: string) {\r\n  const specialChars = [\"*\", \"?\", \"[\", \"]\"];\r\n  const idx = [...pattern].findIndex(c => specialChars.includes(c));\r\n\r\n  if (idx === -1) {\r\n    return dirname(pattern);\r\n  }\r\n\r\n  return dirname(pattern.slice(0, idx + 1));\r\n}\r\n\r\nfunction isGlob(pattern: string): boolean {\r\n  const specialChars = [\"*\", \"?\", \"[\", \"]\"];\r\n  return specialChars.some(c => pattern.includes(c));\r\n}\r\n\r\nfunction normalizeFilePath(path: string, outDir: string) {\r\n  if (path.startsWith('.')) {\r\n    path = resolve(path);\r\n  } else if (!isAbsolute(path)) {\r\n    path = outDir + '/' + path;\r\n  }\r\n\r\n  return path;\r\n}\r\n\r\nexport function fileToId(input: string, group?: string) {\r\n  input = normalize(input);\r\n\r\n  group ||= randomBytes(4).toString('hex');\r\n\r\n  return group + '-' + shortHash(input);\r\n}\r\n","import { MaybePromise } from '@/types';\r\nimport { fileToId } from '@/utilities/fs.ts';\r\nimport { normalize, parse } from 'node:path';\r\nimport { PreRenderedChunk } from 'rollup';\r\n\r\nexport default class BuildTask {\r\n  id: string;\r\n  output?: string | ((chunkInfo: PreRenderedChunk) => any);\r\n  postCallbacks: (() => MaybePromise<any>)[] = [];\r\n\r\n  constructor(public input: string, public group?: string) {\r\n    this.id = BuildTask.toFileId(input, group);\r\n\r\n    this.input = normalize(input);\r\n  }\r\n\r\n  dest(output?: string | ((chunkInfo: PreRenderedChunk) => any)) {\r\n    if (typeof output === 'string') {\r\n      output = this.normalizeOutput(output);\r\n    }\r\n\r\n    this.output = output;\r\n\r\n    return this;\r\n  }\r\n\r\n  addPostCallback(callback: () => void) {\r\n    this.postCallbacks.push(callback);\r\n    return this;\r\n  }\r\n\r\n  normalizeOutput(output: string, ext = '.js') {\r\n    if (output.endsWith('/') || output.endsWith('\\\\')) {\r\n      output += parse(this.input).name + ext;\r\n    }\r\n\r\n    // if (output.startsWith('.')) {\r\n    //   output = resolve(output);\r\n    // }\r\n\r\n    return output;\r\n  }\r\n\r\n  static toFileId(input: string, group?: string) {\r\n    return fileToId(input, group);\r\n  }\r\n}\r\n\r\n","import { OverrideOptions } from '@/types';\r\nimport { cloneDeep, merge } from 'lodash-es';\r\nimport { inspect } from 'node:util';\r\nimport { OutputOptions } from 'rollup';\r\nimport { mergeConfig, UserConfig } from 'vite';\r\n\r\nexport function mergeOptions<T extends Record<string, any> = Record<string, any>>(\r\n  base: T,\r\n  ...overrides: (OverrideOptions<T> | undefined)[]\r\n): T {\r\n  if (!overrides.length) {\r\n    return base;\r\n  }\r\n\r\n  for (const override of overrides) {\r\n    if (!override) {\r\n      continue;\r\n    }\r\n\r\n    if (typeof override === 'function') {\r\n      base = override(base) ?? base;\r\n    } else {\r\n      // @ts-ignore\r\n      base = mergeConfig(base, override);\r\n    }\r\n  }\r\n\r\n  return base;\r\n}\r\n\r\nexport function appendMinFileName(output: OutputOptions): OutputOptions {\r\n  output = cloneDeep(output);\r\n\r\n  if (output.file) {\r\n    const parts = output.file.split('.');\r\n    const ext = parts.pop();\r\n    output.file = `${parts.join('.')}.min.${ext}`;\r\n  } else if (output.dir && typeof output.entryFileNames === 'string') {\r\n    const parts = output.entryFileNames.split('.');\r\n    const ext = parts.pop();\r\n    output.entryFileNames = `${parts.join('.')}.min.${ext}`;\r\n  }\r\n\r\n  return output;\r\n}\r\n\r\nexport function show(data: any, depth = 10) {\r\n  console.log(inspect(data, { depth, colors: true }));\r\n}\r\n","import BuildTask from '@/builder/BuildTask.ts';\r\nimport { FileTasks, FusionVitePluginOptions, LinkOptions, RunnerCliParams } from '@/types';\r\nimport { show } from '@/utilities/utilities.ts';\r\nimport { get, set } from 'lodash-es';\r\nimport { isAbsolute, relative } from 'node:path';\r\nimport { PreRenderedAsset, PreRenderedChunk, RollupOptions } from 'rollup';\r\nimport { MaybePromise } from '@/types';\r\nimport { ConfigEnv, mergeConfig, PluginOption, UserConfig, Plugin } from 'vite';\r\n\r\nexport default class ConfigBuilder {\r\n  static globalOverrideConfig: UserConfig = {};\r\n  overrideConfig: UserConfig = {};\r\n\r\n  entryFileNamesCallbacks: ((chunkInfo: PreRenderedChunk) => string | undefined | void)[] = [];\r\n  chunkFileNamesCallbacks: ((chunkInfo: PreRenderedChunk) => string | undefined | void)[] = [];\r\n  assetFileNamesCallbacks: ((chunkInfo: PreRenderedAsset) => string | undefined | void)[] = [];\r\n\r\n  moveTasks: FileTasks = [];\r\n  copyTasks: FileTasks = [];\r\n  linkTasks: FileTasks<'link'> = [];\r\n  postBuildCallbacks: (() => MaybePromise<void>)[] = [];\r\n  resolveIdCallbacks: Exclude<Plugin['resolveId'], undefined>[] = [];\r\n  loadCallbacks: Exclude<Plugin['load'], undefined>[] = [];\r\n  // fileNameMap: Record<string, string> = {};\r\n\r\n  // externals: ((source: string, importer: string | undefined, isResolved: boolean) => boolean | string | NullValue)[] = [];\r\n  cleans: string[] = [];\r\n\r\n  tasks: Map<string, BuildTask> = new Map();\r\n\r\n  constructor(public config: UserConfig, public env: ConfigEnv, public fusionOptions: FusionVitePluginOptions) {\r\n    // this.ensurePath('build', {});\r\n    // this.ensurePath('build.rollupOptions', {\r\n    //   input: {},\r\n    //   output: this.getDefaultOutput(),\r\n    // });\r\n    // this.ensurePath('plugins', []);\r\n\r\n    this.config = mergeConfig<UserConfig, UserConfig>(this.config, {\r\n      build: {\r\n        manifest: 'manifest.json',\r\n        rollupOptions: {\r\n          preserveEntrySignatures: 'strict',\r\n          input: {},\r\n          output: this.getDefaultOutput(),\r\n          // external: (source: string, importer: string | undefined, isResolved: boolean) => {\r\n          //   for (const external of this.externals) {\r\n          //     const result = external(source, importer, isResolved);\r\n          //\r\n          //     if (result) {\r\n          //       return true;\r\n          //     }\r\n          //   }\r\n          // },\r\n        },\r\n        emptyOutDir: false,\r\n        sourcemap: env.mode !== 'production' ? 'inline' : false,\r\n      },\r\n      plugins: [],\r\n      css: {\r\n        devSourcemap: true,\r\n      },\r\n      esbuild: {\r\n        // Todo: Remove if esbuild supports decorators by default\r\n        target: 'es2022',\r\n      }\r\n    });\r\n\r\n    this.addTask('hidden:placeholder');\r\n  }\r\n\r\n  merge(override: UserConfig | ((config: UserConfig) => UserConfig)) {\r\n    if (typeof override === 'function') {\r\n      this.config = override(this.config) ?? this.config;\r\n\r\n      return this;\r\n    }\r\n\r\n    this.config = mergeConfig(this.config, override);\r\n\r\n    return this;\r\n  }\r\n\r\n  private getDefaultOutput(): RollupOptions['output'] {\r\n    return {\r\n      entryFileNames: (chunkInfo) => {\r\n        const name = this.getChunkNameFromTask(chunkInfo);\r\n\r\n        if (name) {\r\n          return name;\r\n        }\r\n\r\n        for (const entryFileNamesCallback of this.entryFileNamesCallbacks) {\r\n          const name = entryFileNamesCallback(chunkInfo);\r\n\r\n          if (name) {\r\n            return name;\r\n          }\r\n        }\r\n\r\n        // console.log(chunkInfo, this.relativePath(chunkInfo.facadeModuleId));\r\n\r\n        return '[name].js';\r\n      },\r\n      chunkFileNames: (chunkInfo) => {\r\n        const name = this.getChunkNameFromTask(chunkInfo);\r\n\r\n        if (name) {\r\n          return name;\r\n        }\r\n\r\n        for (const chunkFileNamesCallback of this.chunkFileNamesCallbacks) {\r\n          const name = chunkFileNamesCallback(chunkInfo);\r\n\r\n          if (name) {\r\n            return name;\r\n          }\r\n        }\r\n\r\n        const chunkDir = this.getChunkDir();\r\n\r\n        return `${chunkDir}/[name]-[hash].js`;\r\n      },\r\n      assetFileNames: (assetInfo) => {\r\n        // if (this.fileNameMap[assetInfo.name]) {\r\n        //   assetInfo.name = this.fileNameMap[assetInfo.name];\r\n        //   return assetInfo.name;\r\n        // }\r\n\r\n        for (const assetFileNamesCallback of this.assetFileNamesCallbacks) {\r\n          const name = assetFileNamesCallback(assetInfo);\r\n\r\n          if (name) {\r\n            return name;\r\n          }\r\n        }\r\n\r\n        return '[name].[ext]';\r\n      }\r\n    };\r\n  }\r\n\r\n  private getChunkDir(): string {\r\n    let chunkDir = this.fusionOptions.chunkDir ?? 'chunks';\r\n    chunkDir.replace(/\\\\/g, '/');\r\n\r\n    // Ensure trailing slash\r\n    if (chunkDir && !chunkDir.endsWith('/')) {\r\n      chunkDir += '/';\r\n    }\r\n\r\n    if (chunkDir === './' || chunkDir === '/') {\r\n      chunkDir = '';\r\n    }\r\n\r\n    return chunkDir;\r\n  }\r\n\r\n  private getChunkNameFromTask(chunkInfo: PreRenderedChunk) {\r\n    if (this.tasks.has(chunkInfo.name)) {\r\n      const output = this.tasks.get(chunkInfo.name)?.output;\r\n\r\n      if (output) {\r\n        const name = typeof output === 'function' ? output(chunkInfo) : output;\r\n\r\n        if (!isAbsolute(name)) {\r\n          return name;\r\n        }\r\n      }\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  ensurePath(path: string, def: any = {}) {\r\n    if (get(this.config, path) == null) {\r\n      set(this.config, path, def);\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  get(path: string) {\r\n    return get(this.config, path);\r\n  }\r\n\r\n  set(path: string, value: any) {\r\n    set(this.config, path, value);\r\n    return this;\r\n  }\r\n\r\n  addTask(input: string, group?: string) {\r\n    const task = new BuildTask(input, group);\r\n\r\n    this.tasks.set(task.id, task);\r\n\r\n    const inputOptions = this.config.build!.rollupOptions!.input! as Record<string, string>;\r\n    inputOptions[task.id] = task.input;\r\n\r\n    return task;\r\n  }\r\n\r\n  addCleans(...paths: string[]) {\r\n    this.cleans.push(...paths);\r\n\r\n    return this;\r\n  }\r\n\r\n  // addExternals(externals: Externalize) {\r\n  //   if (Array.isArray(externals)) {\r\n  //     this.externals.push((rollupOptions) => {\r\n  //       rollupOptions.external\r\n  //     })\r\n  //   } else if (typeof externals === 'object') {\r\n  //\r\n  //   } else {\r\n  //\r\n  //   }\r\n  // }\r\n\r\n  // addPlugin(plugin: PluginOption) {\r\n  //   this.config.plugins?.push(plugin);\r\n  // }\r\n  //\r\n  // removePlugin(plugin: string | PluginOption) {\r\n  //   this.config.plugins = this.config.plugins?.filter((p) => {\r\n  //     if (!p) {\r\n  //       return true;\r\n  //     }\r\n  //\r\n  //     if (typeof plugin === 'string' && typeof p === 'object' && 'name' in p) {\r\n  //       return p.name !== plugin;\r\n  //     } else if (typeof plugin === 'object' && typeof p === 'object') {\r\n  //       return p !== plugin;\r\n  //     }\r\n  //\r\n  //     return true;\r\n  //   });\r\n  // }\r\n\r\n  relativePath(to: string) {\r\n    return relative(process.cwd(), to);\r\n  }\r\n\r\n  debug() {\r\n    show(this.config);\r\n  }\r\n}\r\n","import { RunnerCliParams } from '@/types/runner.ts';\r\nimport yargs from 'yargs';\r\n\r\nexport function getArgsAfterDoubleDashes(argv?: string[]): string[] {\r\n  argv ??= process.argv;\r\n\r\n  return argv.slice(2).join(' ')\r\n    // Split by -- and remove the first part\r\n    .split(' -- ').slice(1)\r\n    // Join back and split by space\r\n    .join(' -- ').trim()\r\n    // Split back to array and remove empty values\r\n    .split(' ').filter(v => v !== '');\r\n}\r\n\r\nexport function parseArgv(argv: string[]): RunnerCliParams {\r\n  const app = yargs();\r\n\r\n  // app.option('watch', {\r\n  //   alias: 'w',\r\n  //   type: 'boolean',\r\n  //   description: 'Watch files for changes and re-run the tasks',\r\n  // });\r\n\r\n  app.option('cwd', {\r\n    type: 'string',\r\n    description: 'Current working directory',\r\n  });\r\n\r\n  app.option('list', {\r\n    alias: 'l',\r\n    type: 'boolean',\r\n    description: 'List all available tasks',\r\n  });\r\n\r\n  app.option('config', {\r\n    alias: 'c',\r\n    type: 'string',\r\n    description: 'Path to config file',\r\n  });\r\n\r\n  app.option('server-file', {\r\n    alias: 's',\r\n    type: 'string',\r\n    description: 'Path to server file',\r\n  });\r\n\r\n  // app.option('series', {\r\n  //   alias: 's',\r\n  //   type: 'boolean',\r\n  //   description: 'Run tasks in series instead of parallel',\r\n  // });\r\n\r\n  app.option('verbose', {\r\n    alias: 'v',\r\n    type: 'count',\r\n    description: 'Increase verbosity of output. Use multiple times for more verbosity.',\r\n  });\r\n\r\n  return app.parseSync(argv);\r\n}\r\n","import { ProcessorInterface } from '@/processors/ProcessorInterface.ts';\r\nimport { forceArray } from '@/utilities/arr.ts';\r\nimport { build } from 'esbuild';\r\nimport Module from 'module';\r\nimport { existsSync, writeFileSync } from 'node:fs';\r\nimport { dirname, isAbsolute, resolve } from 'node:path';\r\nimport { MaybeArray, MaybePromise } from '@/types';\r\nimport { ConfigResult, LoadedConfigTask, RunnerCliParams } from '@/types';\r\n\r\nexport async function loadConfigFile(configFile: ConfigResult): Promise<Record<string, LoadedConfigTask>> {\r\n  let path = configFile.path;\r\n\r\n  // If is Windows, Add \"file://\" prefix to path\r\n  if (process.platform === 'win32') {\r\n    // todo: try use pathToFileURL(): import { pathToFileURL } from 'url';\r\n    // Replace backslash to slash\r\n    const winPath = path.replace(/\\\\/g, '/');\r\n    // Add file:// prefix if not exists\r\n    if (!winPath.startsWith('file://')) {\r\n      // Add extra slash to make it absolute path\r\n      // e.g. C:/path/to/file\r\n      // becomes file:///C:/path/to/file\r\n      path = `file:///${winPath}`;\r\n    }\r\n  }\r\n\r\n  if (configFile.ts) {\r\n    const buildResult = await build({\r\n      entryPoints: [configFile.path],\r\n      bundle: true,\r\n      write: false,\r\n      outdir: 'dist',\r\n      platform: 'node',\r\n      format: 'cjs',\r\n      target: 'esnext',\r\n      external: ['../dist', '../dist/*'],\r\n      packages: 'external',\r\n      sourcemap: 'inline',\r\n    });\r\n    \r\n    const output = buildResult.outputFiles[0];\r\n\r\n    const code = Buffer.from(output.contents).toString('utf8');\r\n    writeFileSync(output.path, code);\r\n    const m = new Module(output.path, undefined);\r\n    m.filename = output.path;\r\n    // @ts-ignore\r\n    m.paths = Module._nodeModulePaths(dirname(output.path));\r\n    // @ts-ignore\r\n    m._compile(code, output.path);\r\n\r\n    return expandModules(m.exports);\r\n  } else {\r\n    const modules = await import(path);\r\n\r\n    return expandModules(modules);\r\n  }\r\n}\r\n\r\nexport function expandModules(modules: Record<string, any>) {\r\n  modules = { ...modules };\r\n\r\n  if (modules.__esModule) {\r\n    delete modules.__esModule;\r\n  }\r\n\r\n  return modules;\r\n}\r\n\r\nexport async function resolveTaskResults(task: LoadedConfigTask) {\r\n  task = await task;\r\n\r\n  return Promise.all(forceArray(task));\r\n}\r\n\r\nexport async function resolveTaskOptions(task: LoadedConfigTask, resolveSubFunctions = false): Promise<ProcessorInterface[]> {\r\n  task = await task;\r\n\r\n  if (!resolveSubFunctions && Array.isArray(task)) {\r\n    const results = await Promise.all(task.map((task) => resolveTaskOptions(task, true)));\r\n    return results.flat();\r\n  }\r\n\r\n  if (typeof task === 'function') {\r\n    return resolvePromisesToFlatArray(await task() as any, task?.name);\r\n  }\r\n\r\n  return resolvePromisesToFlatArray((await task) as MaybeArray<ProcessorInterface>, (task as any)?.name);\r\n}\r\n\r\nasync function resolvePromisesToFlatArray(tasks: MaybeArray<MaybePromise<ProcessorInterface>>, name?: string) {\r\n  if (!Array.isArray(tasks)) {\r\n    return [await tasks];\r\n  }\r\n\r\n  const resolvedTasks = await Promise.all(tasks);\r\n  const returnTasks = [];\r\n\r\n  for (const resolvedTask of resolvedTasks) {\r\n    if (Array.isArray(resolvedTask)) {\r\n      returnTasks.push(...resolvedTask);\r\n    } else {\r\n      returnTasks.push(resolvedTask);\r\n    }\r\n  }\r\n\r\n  return returnTasks;\r\n}\r\n\r\nexport function mustGetAvailableConfigFile(root: string, params: RunnerCliParams): ConfigResult {\r\n  const found = getAvailableConfigFile(root, params);\r\n\r\n  if (!found) {\r\n    throw new Error('No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.');\r\n  }\r\n\r\n  return found;\r\n}\r\n\r\nexport function getAvailableConfigFile(root: string, params: RunnerCliParams): ConfigResult | null {\r\n  let found = params?.config;\r\n\r\n  if (found) {\r\n    // If is not absolute of system path(consider Windows), prepend root\r\n    if (!isAbsolute(found)) {\r\n      found = resolve(root, found);\r\n    }\r\n\r\n    if (existsSync(found)) {\r\n      return {\r\n        path: found,\r\n        // get filename from file path\r\n        filename: found.split('/').pop() || '',\r\n        type: getConfigModuleType(found),\r\n        ts: isConfigTypeScript(found),\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  return findDefaultConfig(root);\r\n}\r\n\r\nexport function findDefaultConfig(root: string): ConfigResult | null {\r\n  let file = resolve(root, 'fusionfile.js');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'commonjs',\r\n      ts: false,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.mjs');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: false,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.ts');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: true,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.mts');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: true,\r\n    };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction getConfigModuleType(file: string) {\r\n  let type: 'commonjs' | 'module' | 'unknown' = 'unknown';\r\n\r\n  if (file.endsWith('.cjs')) {\r\n    type = 'commonjs';\r\n  } else if (file.endsWith('.mjs')) {\r\n    type = 'module';\r\n  } else if (file.endsWith('.ts') || file.endsWith('.mts')) {\r\n    type = 'module';\r\n  }\r\n\r\n  return type;\r\n}\r\n\r\nfunction isConfigTypeScript(file: string) {\r\n  return file.endsWith('.ts') || file.endsWith('.mts');\r\n}\r\n","import { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { LoadedConfigTask } from '@/types';\r\nimport { forceArray } from '@/utilities/arr.ts';\r\nimport archy, { type Data } from 'archy';\r\nimport chalk from 'chalk';\r\nimport { MaybeArray } from 'rollup';\r\nimport { UserConfig } from 'vite';\r\nimport { resolveTaskOptions } from './config';\r\n\r\nexport async function displayAvailableTasks(tasks: Record<string, LoadedConfigTask>) {\r\n  const keys = Object.keys(tasks);\r\n\r\n  // Sort put default as first if exists\r\n  keys.sort((a, b) => {\r\n    if (a === 'default') {\r\n      return -1;\r\n    }\r\n\r\n    if (b === 'default') {\r\n      return 1;\r\n    }\r\n\r\n    return a.localeCompare(b);\r\n  });\r\n\r\n  const nodes: Array<Data | string> = [];\r\n\r\n  for (const key of keys) {\r\n    const task = tasks[key];\r\n    // const taskOptions = await resolveTaskOptions(task, true);\r\n\r\n    nodes.push(await describeTasks(key, task));\r\n  }\r\n\r\n  const text = archy({\r\n    label: chalk.magenta('Available Tasks'),\r\n    nodes\r\n  });\r\n\r\n  console.log(text);\r\n}\r\n\r\nasync function describeTasks(name: string, tasks: LoadedConfigTask): Promise<Data> {\r\n  const nodes = [];\r\n  tasks = forceArray(await tasks);\r\n\r\n  for (let task of tasks) {\r\n    const processors = await resolveTaskOptions(task, true);\r\n\r\n    for (const processor of processors) {\r\n      if (typeof processor === 'function') {\r\n        nodes.push(\r\n          await describeTasks((processor as Function).name, processor)\r\n        );\r\n      } else {\r\n        nodes.push(...await describeProcessor(processor));\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    label: chalk.cyan(name),\r\n    nodes\r\n  };\r\n}\r\n\r\nasync function describeProcessor(processor: ProcessorInterface): Promise<string[]> {\r\n  const results = await processor.preview();\r\n\r\n  return Promise.all(results.map((result) => describeProcessorPreview(result)));\r\n}\r\n\r\nasync function describeProcessorPreview(preview: ProcessorPreview): Promise<string> {\r\n  const str = [];\r\n\r\n  const { input: entry, output, extra } = preview;\r\n\r\n  // Input\r\n  const inputStr = chalk.yellow(entry);\r\n  // if (typeof entry === 'string') {\r\n  //   inputStr = chalk.yellow(entry);\r\n  // } else if (Array.isArray(entry)) {\r\n  //   inputStr = chalk.yellow(entry.join(', '));\r\n  // } else if (typeof entry === 'object') {\r\n  //   inputStr = chalk.yellow(Object.values(entry).join(', '));\r\n  // }\r\n  str.push(`Input: ${inputStr}`);\r\n\r\n  // Output\r\n  // if (output) {\r\n  //   const outputs = Array.isArray(output) ? output : [output];\r\n  //   outputs.forEach((output, index) => {\r\n  //     let outStr = '';\r\n  //     if (output.file) {\r\n  //       outStr = chalk.green(output.file);\r\n  //     } else if (output.dir) {\r\n  //       outStr = chalk.green(output.dir);\r\n  //     }\r\n  //     str.push(`Output[${index}]: ${outStr}`);\r\n  //   });\r\n  // }\r\n\r\n  const outStr = chalk.green(output);\r\n  str.push(`Output: ${outStr}`);\r\n\r\n  return str.join(\" - \");\r\n}\r\n\r\nfunction countTask(task: MaybeArray<UserConfig>) {\r\n  if (Array.isArray(task)) {\r\n    return task.length;\r\n  }\r\n\r\n  return 1;\r\n}\r\n","import { ProcessorInterface } from '@/processors/ProcessorInterface.ts';\r\nimport chalk from 'chalk';\r\nimport { uniq } from 'lodash-es';\r\nimport { MaybeArray } from 'rollup';\r\nimport { resolveTaskOptions } from '@/runner/config';\r\nimport { LoadedConfigTask, RunningTasks } from '@/types/runner.ts';\r\nimport { UserConfig } from 'vite';\r\n\r\nexport function selectRunningTasks(\r\n  input: string[],\r\n  tasks: Record<string, LoadedConfigTask>\r\n): Record<string, LoadedConfigTask> {\r\n  input = uniq(input);\r\n\r\n  if (input.length === 0) {\r\n    input.push('default');\r\n  }\r\n\r\n  const selected: Record<string, LoadedConfigTask> = {};\r\n\r\n  for (const name of input) {\r\n    if (tasks[name]) {\r\n      selected[name] = tasks[name];\r\n    } else {\r\n      throw new Error(`Task \"${chalk.cyan(name)}\" not found in fusion config.`);\r\n    }\r\n  }\r\n\r\n  return selected;\r\n}\r\n\r\nexport async function resolveAllTasksAsProcessors(tasks: Record<string, LoadedConfigTask>): Promise<RunningTasks> {\r\n  const cache: Record<string, MaybeArray<LoadedConfigTask>> = {};\r\n  const allTasks: RunningTasks = {};\r\n\r\n  for (const name in tasks) {\r\n    const task = tasks[name];\r\n\r\n    allTasks[name] = (await resolveTaskAsFlat(name, task, cache));\r\n  }\r\n\r\n  return allTasks;\r\n}\r\n\r\nexport async function resolveTaskAsFlat(\r\n  name: string,\r\n  task: LoadedConfigTask,\r\n  cache: Record<string, MaybeArray<LoadedConfigTask>>\r\n): Promise<ProcessorInterface[]> {\r\n  const results: ProcessorInterface[] = [];\r\n\r\n  if (Array.isArray(task)) {\r\n    for (const n in task) {\r\n      const t = task[n];\r\n      results.push(...await resolveTaskAsFlat(n, t, cache));\r\n    }\r\n  } else if (typeof task === 'function') {\r\n    name = task.name || name;\r\n\r\n    if (cache[name]) {\r\n      return [];\r\n    }\r\n\r\n    cache[name] = task;\r\n\r\n    const resolved = await resolveTaskOptions(task, true);\r\n\r\n    if (Array.isArray(resolved)) {\r\n      for (const n in resolved) {\r\n        const t = resolved[n];\r\n        results.push(...await resolveTaskAsFlat(n, t, cache));\r\n      }\r\n    }\r\n  } else {\r\n    results.push(await task);\r\n  }\r\n\r\n  return results;\r\n}\r\n","export * from '@/dep';\r\nimport * as fusion from '@/dep';\r\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\r\nimport { prepareParams } from '@/params';\r\nimport { getArgsAfterDoubleDashes, parseArgv } from '@/runner/app';\r\nimport { expandModules, loadConfigFile, mustGetAvailableConfigFile } from '@/runner/config';\r\nimport { displayAvailableTasks } from '@/runner/describe.ts';\r\nimport { resolveAllTasksAsProcessors, selectRunningTasks } from '@/runner/tasks.ts';\r\nimport { FusionPlugin, FusionVitePluginOptions, FusionVitePluginUnresolved, LoadedConfigTask } from '@/types';\r\nimport { forceArray } from '@/utilities/arr.ts';\r\nimport { cleanFiles, copyFilesAndLog, linkFilesAndLog, moveFilesAndLog } from '@/utilities/fs.ts';\r\nimport { mergeOptions, show } from '@/utilities/utilities.ts';\r\nimport fs from 'fs';\r\nimport { uniq } from 'lodash-es';\r\nimport { existsSync, writeFileSync } from 'node:fs';\r\nimport { resolve } from 'node:path';\r\nimport { Logger, mergeConfig, PluginOption, ResolvedConfig, UserConfig } from 'vite';\r\n\r\nlet params = parseArgv(getArgsAfterDoubleDashes(process.argv));\r\nprepareParams(params);\r\n\r\nexport let builder: ConfigBuilder;\r\n\r\nconst originalTasks = params._;\r\nconst extraVitePlugins: FusionPlugin[] = [];\r\n\r\nexport function useFusion(fusionOptions: FusionVitePluginUnresolved = {}, tasks?: string | string[]): PluginOption {\r\n  let logger: Logger;\r\n  let resolvedConfig: ResolvedConfig;\r\n  let exitHandlersBound = false;\r\n\r\n  const resolvedOptions = prepareFusionOptions(fusionOptions);\r\n\r\n  if (\r\n    typeof tasks === 'string'\r\n    || (Array.isArray(tasks) && tasks.length > 0)\r\n  ) {\r\n    params._ = forceArray(tasks);\r\n  } else {\r\n    params._ = originalTasks;\r\n  }\r\n\r\n  params = mergeOptions(params, resolvedOptions.cliParams);\r\n\r\n  return [\r\n    {\r\n      name: 'fusion',\r\n      configResolved(config) {\r\n        resolvedConfig = config;\r\n\r\n        logger = config.logger;\r\n\r\n        // @ts-ignore\r\n        config.plugins.push(...extraVitePlugins);\r\n\r\n        for (const plugin of (config.plugins as FusionPlugin[])) {\r\n          if ('buildConfig' in plugin) {\r\n            plugin.buildConfig?.(builder);\r\n          }\r\n        }\r\n      },\r\n      async config(config, env) {\r\n        let root: string;\r\n\r\n        if (config.root) {\r\n          root = resolve(config.root);\r\n        } else {\r\n          root = params.cwd || process.cwd();\r\n        }\r\n\r\n        delete config.root;\r\n        // delete builder.config.root;\r\n\r\n        process.chdir(root);\r\n\r\n        builder = new ConfigBuilder(config, env, resolvedOptions);\r\n\r\n        // Retrieve config file\r\n        let tasks: Record<string, LoadedConfigTask>;\r\n\r\n        if (typeof resolvedOptions.fusionfile === 'string' || !resolvedOptions.fusionfile) {\r\n          params.config ??= resolvedOptions.fusionfile;\r\n          const configFile = mustGetAvailableConfigFile(root, params);\r\n\r\n          // Load config\r\n          tasks = await loadConfigFile(configFile);\r\n        } else if (typeof resolvedOptions.fusionfile === 'function') {\r\n          tasks = expandModules(await resolvedOptions.fusionfile());\r\n        } else {\r\n          tasks = expandModules(resolvedOptions.fusionfile);\r\n        }\r\n\r\n        // Describe tasks\r\n        if (params.list) {\r\n          await displayAvailableTasks(tasks);\r\n          return;\r\n        }\r\n\r\n        // Select running tasks\r\n        const selectedTasks = selectRunningTasks([...params._] as string[], tasks);\r\n\r\n        const runningTasks = (await resolveAllTasksAsProcessors(selectedTasks));\r\n\r\n        for (const taskName in runningTasks) {\r\n          const processors = runningTasks[taskName];\r\n\r\n          for (const processor of processors) {\r\n            await processor.config(taskName, builder);\r\n          }\r\n        }\r\n\r\n        builder.merge(ConfigBuilder.globalOverrideConfig);\r\n        builder.merge(builder.overrideConfig);\r\n\r\n        // for (const plugin of plugins) {\r\n        //   if (plugin.buildConfig) {\r\n        //     await plugin.buildConfig(builder, env);\r\n        //   }\r\n        // }\r\n\r\n        // console.log('plugin bottom', builder.config);\r\n        //\r\n        // show(builder.overrideConfig, 15)\r\n        // show(builder.config, 15)\r\n\r\n        return builder.config;\r\n      },\r\n      outputOptions(options) {\r\n        // Protect upload folder\r\n        if (resolvedConfig.build.emptyOutDir) {\r\n          const dir = resolvedConfig.build.outDir;\r\n          const uploadDir = resolve(dir, 'upload');\r\n\r\n          if (existsSync(uploadDir)) {\r\n            throw new Error(\r\n              `The output directory: \"${dir}\" contains an \"upload\" folder, please move this folder away or set an different fusion outDir.`\r\n            );\r\n          }\r\n        }\r\n      },\r\n      async buildStart(options) {\r\n        if (builder.cleans.length > 0) {\r\n          await cleanFiles(builder.cleans, resolvedConfig.build.outDir || process.cwd());\r\n        }\r\n      },\r\n\r\n      // Server\r\n      configureServer(server) {\r\n        server.httpServer?.once('listening', () => {\r\n          const scheme = server.config.server.https ? 'https' : 'http';\r\n          const address = server.httpServer?.address();\r\n          const host = address && typeof address !== 'string' ? address.address : 'localhost';\r\n          const port = address && typeof address !== 'string' ? address.port : 80;\r\n\r\n          const url = `${scheme}://${host}:${port}/`;\r\n          const serverFile = resolve(\r\n            server.config.root,\r\n            resolvedOptions.cliParams?.serverFile ?? 'tmp/vite-server'\r\n          );\r\n\r\n          writeFileSync(resolve(server.config.root, serverFile), url);\r\n\r\n          if (!exitHandlersBound) {\r\n            process.on(\"exit\", () => {\r\n              if (fs.existsSync(serverFile)) {\r\n                fs.rmSync(serverFile);\r\n              }\r\n            });\r\n            process.on(\"SIGINT\", () => process.exit());\r\n            process.on(\"SIGTERM\", () => process.exit());\r\n            process.on(\"SIGHUP\", () => process.exit());\r\n            exitHandlersBound = true;\r\n          }\r\n        });\r\n      }\r\n    },\r\n    {\r\n      name: 'fusion:pre-handles',\r\n      enforce: 'pre',\r\n      async resolveId(source, importer, options) {\r\n        for (const resolveId of builder.resolveIdCallbacks) {\r\n          if (typeof resolveId !== 'function') {\r\n            continue;\r\n          }\r\n\r\n          const result = await resolveId.call(this, source, importer, options);\r\n\r\n          if (result) {\r\n            return result;\r\n          }\r\n        }\r\n\r\n        if (source.startsWith('hidden:')) {\r\n          return source;\r\n        }\r\n      },\r\n      async load(source, options) {\r\n        for (const load of builder.loadCallbacks) {\r\n          if (typeof load !== 'function') {\r\n            continue;\r\n          }\r\n\r\n          const result = await load.call(this, source, options);\r\n\r\n          if (result) {\r\n            return result;\r\n          }\r\n        }\r\n\r\n        if (source.startsWith('hidden:')) {\r\n          return '';\r\n        }\r\n      },\r\n    },\r\n    {\r\n      name: 'fusion:post-handles',\r\n      generateBundle(options, bundle) {\r\n        for (const [fileName, chunk] of Object.entries(bundle)) {\r\n          if (chunk.type === 'chunk' && chunk.facadeModuleId?.startsWith('hidden:')) {\r\n            delete bundle[fileName];\r\n          }\r\n        }\r\n      },\r\n      async writeBundle(options, bundle) {\r\n        const outDir = resolvedConfig.build.outDir || process.cwd();\r\n\r\n        // Todo: override logger to replace vite's files logs\r\n        // @see https://github.com/windwalker-io/core/issues/1355\r\n        await moveFilesAndLog(builder.moveTasks, outDir, logger);\r\n        await copyFilesAndLog(builder.copyTasks, outDir, logger);\r\n        await linkFilesAndLog(builder.linkTasks, outDir, logger);\r\n\r\n        for (const callback of builder.postBuildCallbacks) {\r\n          await callback();\r\n        }\r\n\r\n        for (const [name, task] of builder.tasks) {\r\n          for (const callback of task.postCallbacks) {\r\n            await callback();\r\n          }\r\n        }\r\n      },\r\n    },\r\n  ];\r\n}\r\n\r\nfunction prepareFusionOptions(options: FusionVitePluginUnresolved): FusionVitePluginOptions {\r\n  if (typeof options === 'string') {\r\n    return {\r\n      fusionfile: options,\r\n    };\r\n  }\r\n\r\n  if (typeof options === 'function') {\r\n    return {\r\n      fusionfile: options,\r\n    };\r\n  }\r\n\r\n  return options;\r\n}\r\n\r\nexport function configureBuilder(handler: (builder: ConfigBuilder) => void) {\r\n  handler(builder);\r\n}\r\n\r\nexport function mergeViteConfig(config: UserConfig | null) {\r\n  // if (config === null) {\r\n  //   ConfigBuilder.globalOverrideConfig = {};\r\n  //   return;\r\n  // }\r\n  //\r\n  // ConfigBuilder.globalOverrideConfig = mergeConfig(ConfigBuilder.globalOverrideConfig, config);\r\n  if (config === null) {\r\n    builder.overrideConfig = {};\r\n    return;\r\n  }\r\n\r\n  builder.overrideConfig = mergeConfig(builder.overrideConfig, config);\r\n}\r\n\r\nexport function outDir(outDir: string) {\r\n  // ConfigBuilder.globalOverrideConfig = mergeConfig<UserConfig, UserConfig>(ConfigBuilder.globalOverrideConfig, {\r\n  //   build: {\r\n  //     outDir\r\n  //   }\r\n  // });\r\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\r\n    build: {\r\n      outDir\r\n    }\r\n  });\r\n}\r\n\r\nexport function chunkDir(dir: string) {\r\n  builder.fusionOptions.chunkDir = dir;\r\n}\r\n\r\nexport function alias(src: string, dest: string) {\r\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\r\n    resolve: {\r\n      alias: {\r\n        [src]: dest\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nexport function external(match: string, varName?: string) {\r\n  const globals: Record<string, string> = {};\r\n\r\n  if (varName) {\r\n    globals[match] = varName;\r\n  }\r\n\r\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\r\n    build: {\r\n      rollupOptions: {\r\n        external: [match],\r\n        output: {\r\n          globals\r\n        }\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nexport function plugin(...plugins: FusionPlugin[]) {\r\n  extraVitePlugins.push(...plugins);\r\n}\r\n\r\nexport function clean(...paths: string[]) {\r\n  builder.addCleans(...paths);\r\n\r\n  builder.cleans = uniq(builder.cleans);\r\n}\r\n\r\nexport default {\r\n  ...fusion,\r\n  useFusion,\r\n  configureBuilder,\r\n  mergeViteConfig,\r\n  outDir,\r\n  chunkDir,\r\n  alias,\r\n  external,\r\n  plugin,\r\n  clean,\r\n  params,\r\n};\r\n"],"names":["forceArray","item","handleMaybeArray","items","callback","handleForceArray","css","input","output","options","CssProcessor","taskName","builder","task","assetInfo","name","basename","parse","js","JsProcessor","chunkInfo","move","dest","MoveProcessor","copy","CopyProcessor","link","LinkProcessor","handler","CallbackProcessor","callbackAfterBuild","afterBuild","params","prepareParams","p","isVerbose","isProd","isDev","isWindows","shortHash","bufferOrString","short","hash","Crypto","handleFilesOperation","src","promises","normalizeFilePath","base","getGlobBaseFromPattern","sources","isGlob","fg","source","dir","resolvedDest","endsWithSlash","relative","dirname","fs","moveFilesAndLog","tasks","outDir","logger","ps","copyFilesAndLog","linkFilesAndLog","symlink","cleanFiles","patterns","resolve","protectDir","copyGlob","moveGlob","target","force","path","pattern","specialChars","idx","c","isAbsolute","fileToId","group","normalize","randomBytes","BuildTask","ext","mergeOptions","overrides","override","mergeConfig","show","data","depth","inspect","ConfigBuilder","config","env","fusionOptions","entryFileNamesCallback","chunkFileNamesCallback","assetFileNamesCallback","chunkDir","def","get","set","value","inputOptions","paths","to","getArgsAfterDoubleDashes","argv","v","parseArgv","app","yargs","loadConfigFile","configFile","winPath","build","code","writeFileSync","m","Module","expandModules","modules","resolveTaskOptions","resolveSubFunctions","resolvePromisesToFlatArray","resolvedTasks","returnTasks","resolvedTask","mustGetAvailableConfigFile","root","found","getAvailableConfigFile","existsSync","getConfigModuleType","isConfigTypeScript","findDefaultConfig","file","type","displayAvailableTasks","keys","a","b","nodes","key","describeTasks","text","archy","chalk","processors","processor","describeProcessor","results","result","describeProcessorPreview","preview","str","entry","extra","inputStr","outStr","selectRunningTasks","uniq","selected","resolveAllTasksAsProcessors","cache","allTasks","resolveTaskAsFlat","n","t","resolved","originalTasks","extraVitePlugins","useFusion","resolvedConfig","exitHandlersBound","resolvedOptions","prepareFusionOptions","plugin","selectedTasks","runningTasks","uploadDir","server","scheme","address","host","port","url","serverFile","importer","resolveId","load","bundle","fileName","chunk","configureBuilder","mergeViteConfig","alias","external","match","varName","globals","plugins","clean","index","fusion"],"mappings":"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"}