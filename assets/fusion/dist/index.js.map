{"version":3,"file":"index.js","sources":["../src/utilities/arr.ts","../src/processors/css.ts","../src/processors/js.ts","../src/processors/move.ts","../src/processors/copy.ts","../src/processors/link.ts","../src/processors/callback.ts","../src/params.ts","../src/utilities/env.ts","../src/utilities/crypto.ts","../src/utilities/fs.ts","../src/builder/BuildTask.ts","../src/utilities/utilities.ts","../src/builder/ConfigBuilder.ts","../src/runner/app.ts","../src/runner/config.ts","../src/runner/describe.ts","../src/runner/tasks.ts","../src/index.ts"],"sourcesContent":["import { MaybeArray } from 'rollup';\r\n\r\nexport function forceArray<T>(item: T | T[]): T[] {\r\n  if (Array.isArray(item)) {\r\n    return item;\r\n  } else {\r\n    return [item];\r\n  }\r\n}\r\n\r\nexport function handleMaybeArray<T, R>(\r\n  items: T | T[],\r\n  callback: (item: T) => R\r\n): T extends any[] ? R[] : R {\r\n  if (Array.isArray(items)) {\r\n    return items.map(callback) as any;\r\n  } else {\r\n    return callback(items as T) as any;\r\n  }\r\n}\r\n\r\nexport function handleForceArray<T, R>(\r\n  items: T | T[],\r\n  callback: (item: T) => R\r\n): R[] {\r\n  items = forceArray(items);\r\n\r\n  return items.map(callback) as any;\r\n}\r\n\r\nexport function appendToMaybeArray<T>(items: MaybeArray<T>, value: T): T[] {\r\n  if (Array.isArray(items)) {\r\n    items.push(value);\r\n\r\n    return items;\r\n  } else {\r\n    return [items, value];\r\n  }\r\n}\r\n","import BuildTask from '@/builder/BuildTask.ts';\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface';\nimport { CssOptions, TaskInput, TaskOutput } from '@/types';\nimport { forceArray, handleForceArray, handleMaybeArray } from '@/utilities/arr';\nimport { basename, parse } from 'node:path';\nimport { MaybePromise } from '@/types';\n\nexport function css(\n  input: TaskInput,\n  output?: TaskOutput,\n  options: CssOptions = {}\n): CssProcessor {\n  return new CssProcessor(input, output, options);\n}\n\nexport class CssProcessor implements ProcessorInterface {\n  constructor(protected input: TaskInput, protected output?: TaskOutput, protected options: CssOptions = {}) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): BuildTask[] {\n    return handleForceArray(this.input, (input) => {\n      const task = builder.addTask(input, taskName);\n\n      builder.assetFileNamesCallbacks.push((assetInfo) => {\n        const name = assetInfo.names[0];\n\n        if (!name) {\n          return undefined;\n        }\n\n        // Rename only if the asset name matches the task id with .css extension\n        if (basename(name, '.css') === task.id) {\n          if (!this.output) {\n            return parse(input).name + '.css';\n          }\n\n          return task.normalizeOutput(this.output, '.css');\n\n          // if (!isAbsolute(name)) {\n          //   return name;\n          // } else {\n          //   builder.moveFilesMap[task.id + '.css'] = name;\n          // }\n        }\n      });\n\n      return task;\n    });\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return forceArray(this.input).map((input) => {\n      return {\n        input,\n        output: this.output || basename(input),\n        extra: {}\n      };\n    });\n  }\n}\n","import BuildTask from '@/builder/BuildTask.ts';\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\nimport { TaskInput, TaskOutput } from '@/types';\nimport { forceArray, handleForceArray, handleMaybeArray } from '@/utilities/arr';\nimport { basename, parse } from 'node:path';\nimport { MaybePromise } from '@/types';\n\nexport function js(input: TaskInput, output?: TaskOutput): ProcessorInterface {\n  return new JsProcessor(input, output);\n}\n\nexport class JsProcessor implements ProcessorInterface {\n\n  constructor(public input: TaskInput, public output?: TaskOutput) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): BuildTask[] {\n    return handleForceArray(this.input, (input) => {\n      const task = builder.addTask(input, taskName);\n\n      builder.entryFileNamesCallbacks.push((chunkInfo) => {\n        const name = chunkInfo.name;\n\n        if (!name) {\n          return;\n        }\n\n        // Rename only if the asset name matches the task id with .css extension\n        if (name === task.id) {\n          if (!this.output) {\n            return parse(input).name + '.js';\n          }\n\n          return task.normalizeOutput(this.output);\n\n          // if (!isAbsolute(name)) {\n          //   return name;\n          // } else {\n          //   builder.moveFilesMap[task.id + '.css'] = name;\n          // }\n        }\n      });\n\n      return task;\n    });\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return forceArray(this.input).map((input) => {\n      return {\n        input,\n        output: this.output || basename(input),\n        extra: {}\n      };\n    });\n  }\n}\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\nimport { TaskInput } from '@/types';\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\nimport { MaybePromise } from '@/types';\nimport { types } from 'sass';\n\nexport function move(input: TaskInput, dest: string) {\n  return new MoveProcessor(input, dest);\n}\n\nexport class MoveProcessor implements ProcessorInterface {\n  constructor(public input: TaskInput, public dest: string) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\n    handleMaybeArray(this.input, (input) => {\n      builder.moveTasks.push({ src: input, dest: this.dest, options: {} });\n    });\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return forceArray(this.input).map((input) => {\n      return {\n        input,\n        output: this.dest,\n        extra: {}\n      };\n    });\n  }\n}\n\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\nimport { TaskInput } from '@/types';\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\nimport { MaybePromise } from '@/types';\n\nexport function copy(input: TaskInput, dest: string) {\n  return new CopyProcessor(input, dest);\n}\n\nexport class CopyProcessor implements ProcessorInterface {\n  constructor(public input: TaskInput, public dest: string) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\n    handleMaybeArray(this.input, (input) => {\n      builder.copyTasks.push({ src: input, dest: this.dest, options: {} })\n    });\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return forceArray(this.input).map((input) => {\n      return {\n        input,\n        output: this.dest,\n        extra: {}\n      };\n    });\n  }\n}\n\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\nimport { LinkOptions, TaskInput } from '@/types';\nimport { forceArray, handleMaybeArray } from '@/utilities/arr.ts';\nimport { MaybePromise } from '@/types';\n\nexport function link(input: TaskInput, dest: string, options: LinkOptions = {}) {\n  return new LinkProcessor(input, dest, options);\n}\n\nexport class LinkProcessor implements ProcessorInterface {\n  constructor(public input: TaskInput, public dest: string, public options: LinkOptions = {}) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<void> {\n    handleMaybeArray(this.input, (input) => {\n      builder.linkTasks.push({ src: input, dest: this.dest, options: this.options });\n    });\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return forceArray(this.input).map((input) => {\n      return {\n        input,\n        output: this.dest,\n        extra: {}\n      };\n    });\n  }\n}\n\n","import ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\nimport { MaybePromise } from '@/types';\n\ntype CallbackHandler = (taskName: string, builder: ConfigBuilder) => MaybePromise<any>;\n\nexport function callback(handler: CallbackHandler) {\n  return new CallbackProcessor(handler);\n}\n\nexport function callbackAfterBuild(handler: CallbackHandler) {\n  return new CallbackProcessor(handler, true);\n}\n\nclass CallbackProcessor implements ProcessorInterface {\n  constructor(\n    /** @internal */\n    private handler: CallbackHandler,\n    /** @internal */\n    private afterBuild = false\n  ) {\n  }\n\n  config(taskName: string, builder: ConfigBuilder): MaybePromise<any> {\n    if (this.afterBuild) {\n      builder.postBuildCallbacks.push(() => this.handler(taskName, builder));\n    } else {\n      this.handler(taskName, builder);\n    }\n\n    return undefined;\n  }\n\n  preview(): MaybePromise<ProcessorPreview[]> {\n    return [];\n  }\n}\n\n","import { RunnerCliParams } from '@/types';\n\nlet params: RunnerCliParams | undefined = undefined;\n\nexport function prepareParams(p: RunnerCliParams): RunnerCliParams {\n  params = p;\n\n  isVerbose = params?.verbose ? params?.verbose > 0 : false;\n\n  return p;\n}\n\nlet isVerbose = false;\nconst isProd = process.env.NODE_ENV === 'production';\nconst isDev = !isProd;\n\nexport { isVerbose, isDev, isProd, params };\n","export function isWindows() {\n  return process.platform === 'win32';\n}\n","import Crypto from 'crypto';\r\n\r\nexport function shortHash(bufferOrString: Crypto.BinaryLike, short: number | null = 8): string {\r\n  let hash = Crypto.createHash('sha1')\r\n    .update(bufferOrString)\r\n    .digest('hex');\r\n\r\n  if (short && short > 0) {\r\n    hash = hash.substring(0, short);\r\n  }\r\n\r\n  return hash;\r\n}\r\n\r\n\r\n","import { FileTasks } from '@/types';\nimport { isWindows } from '@/utilities/env.ts';\nimport { shortHash } from '@/utilities/crypto.ts';\nimport fg from 'fast-glob';\nimport fs from 'fs-extra';\nimport { randomBytes } from 'node:crypto';\nimport { dirname, isAbsolute, normalize, relative, resolve } from 'node:path';\nimport { Logger } from 'vite';\n\nfunction handleFilesOperation(\n  src: string,\n  dest: string,\n  options: {\n    outDir: string;\n    handler: (src: string, dest: string) => Promise<any>;\n    globOptions?: fg.Options;\n  }\n) {\n  const promises = [];\n  src = normalizeFilePath(src, options.outDir);\n  dest = normalizeFilePath(dest, options.outDir);\n\n  const base = getGlobBaseFromPattern(src);\n  const sources = isGlob(src)\n    ? fg.globSync(src.replace(/\\\\/g, '/'), options.globOptions)\n    : [src];\n\n  for (let source of sources) {\n    let dir;\n    let resolvedDest = dest;\n\n    if (endsWithSlash(dest)) {\n      dir = resolvedDest;\n      resolvedDest = resolvedDest + relative(base, source);\n    } else {\n      dir = dirname(resolvedDest);\n    }\n\n    fs.ensureDirSync(dir);\n\n    promises.push(options.handler(source, resolvedDest));\n  }\n\n  return promises;\n}\n\nexport function moveFilesAndLog(tasks: FileTasks, outDir: string, logger: Logger) {\n  const promises = [];\n\n  for (const { src, dest, options } of tasks) {\n    const ps = handleFilesOperation(\n      src,\n      dest,\n      {\n        outDir,\n        handler: async (src, dest) => {\n          logger.info(`Moving file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\n          return fs.move(src, dest, { overwrite: true });\n        },\n        globOptions: { onlyFiles: true }\n      }\n    );\n\n    promises.push(...ps);\n  }\n\n  return Promise.all(promises);\n}\n\nexport function copyFilesAndLog(tasks: FileTasks, outDir: string, logger: Logger) {\n  const promises = [];\n\n  for (const { src, dest, options } of tasks) {\n    const ps = handleFilesOperation(\n      src,\n      dest, {\n        outDir,\n        handler: async (src, dest) => {\n          logger.info(`Copy file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\n          return fs.copy(src, dest, { overwrite: true });\n        },\n        globOptions: { onlyFiles: true }\n      }\n    );\n\n    promises.push(...ps);\n  }\n\n  return Promise.all(promises);\n}\n\nexport function linkFilesAndLog(tasks: FileTasks<'link'>, outDir: string, logger: Logger) {\n  const promises = [];\n\n  for (const { src, dest, options } of tasks) {\n    const ps = handleFilesOperation(\n      src,\n      dest, {\n        outDir,\n        handler: async (src, dest) => {\n          logger.info(`Link file from ${relative(outDir, src)} to ${relative(outDir, dest)}`);\n          return symlink(src, dest, options?.force ?? false);\n        },\n        globOptions: { onlyFiles: false }\n      }\n    );\n\n    promises.push(...ps);\n  }\n\n  return Promise.all(promises);\n}\n\nexport function cleanFiles(patterns: string[], outDir: string) {\n  const promises = [];\n\n  outDir = outDir.replace(/\\\\/g, '/');\n\n  for (let src of patterns) {\n    src = normalizeFilePath(src, outDir);\n    src = resolve(src);\n    \n    const sources = isGlob(src)\n      ? fg.globSync(src.replace(/\\\\/g, '/'), { onlyFiles: false })\n      : [src];\n\n    // To protect `upload/*` folder.\n    const protectDir = resolve(outDir + '/upload').replace(/\\\\/g, '/');\n\n    for (let source of sources) {\n      if (source.replace(/\\\\/g, '/').startsWith(protectDir)) {\n        throw new Error('Refuse to delete `upload/*` folder.');\n      }\n\n      promises.push(fs.remove(source));\n    }\n  }\n\n  return Promise.all(promises);\n}\n\nexport async function copyGlob(src: string, dest: string): Promise<void> {\n  const promises = handleFilesOperation(\n    src,\n    dest,\n    {\n      outDir: process.cwd(),\n      handler: async (src, dest) => fs.copy(src, dest, { overwrite: true }),\n      globOptions: { onlyFiles: true }\n    }\n  );\n\n  await Promise.all(promises);\n}\n\nexport async function moveGlob(src: string, dest: string): Promise<void> {\n  const promises = handleFilesOperation(\n    src,\n    dest,\n    {\n      outDir: process.cwd(),\n      handler: async (src, dest) => fs.move(src, dest, { overwrite: true }),\n      globOptions: { onlyFiles: true }\n    }\n  );\n\n  await Promise.all(promises);\n}\n\nexport async function symlink(target: string, link: string, force = false) {\n  target = resolve(target);\n  link = resolve(link);\n\n  if (isWindows() && !fs.lstatSync(target).isFile()) {\n    return fs.ensureSymlink(target, link, 'junction');\n  }\n\n  if (isWindows() && fs.lstatSync(target).isFile() && force) {\n    return fs.ensureLink(target, link);\n  }\n\n  return fs.ensureSymlink(target, link);\n}\n\nexport function endsWithSlash(path: string): boolean {\n  return path.endsWith('/') || path.endsWith('\\\\');\n}\n\nexport function getGlobBaseFromPattern(pattern: string) {\n  const specialChars = [\"*\", \"?\", \"[\", \"]\"];\n  const idx = [...pattern].findIndex(c => specialChars.includes(c));\n\n  if (idx === -1) {\n    return dirname(pattern);\n  }\n\n  return dirname(pattern.slice(0, idx + 1));\n}\n\nfunction isGlob(pattern: string): boolean {\n  const specialChars = [\"*\", \"?\", \"[\", \"]\"];\n  return specialChars.some(c => pattern.includes(c));\n}\n\nfunction normalizeFilePath(path: string, outDir: string) {\n  if (path.startsWith('.')) {\n    path = resolve(path);\n  } else if (!isAbsolute(path)) {\n    path = outDir + '/' + path;\n  }\n\n  return path;\n}\n\nexport function fileToId(input: string, group?: string) {\n  input = normalize(input);\n\n  group ||= randomBytes(4).toString('hex');\n\n  return group + '-' + shortHash(input);\n}\n","import { MaybePromise } from '@/types';\nimport { fileToId } from '@/utilities/fs.ts';\nimport { normalize, parse } from 'node:path';\nimport { NormalizedOutputOptions, OutputBundle, PreRenderedChunk } from 'rollup';\n\nexport default class BuildTask {\n  id: string;\n  output?: string | ((chunkInfo: PreRenderedChunk) => any);\n  postCallbacks: ((options: NormalizedOutputOptions, bundle: OutputBundle) => MaybePromise<any>)[] = [];\n\n  constructor(public input: string, public group?: string) {\n    this.id = BuildTask.toFileId(input, group);\n\n    this.input = normalize(input);\n  }\n\n  dest(output?: string | ((chunkInfo: PreRenderedChunk) => any)) {\n    if (typeof output === 'string') {\n      output = this.normalizeOutput(output);\n    }\n\n    this.output = output;\n\n    return this;\n  }\n\n  addPostCallback(callback: () => void) {\n    this.postCallbacks.push(callback);\n    return this;\n  }\n\n  normalizeOutput(output: string, ext = '.js') {\n    if (output.endsWith('/') || output.endsWith('\\\\')) {\n      output += parse(this.input).name + ext;\n    }\n\n    // if (output.startsWith('.')) {\n    //   output = resolve(output);\n    // }\n\n    return output;\n  }\n\n  static toFileId(input: string, group?: string) {\n    return fileToId(input, group);\n  }\n}\n\n","import { OverrideOptions } from '@/types';\nimport { cloneDeep, merge } from 'lodash-es';\nimport { inspect } from 'node:util';\nimport { OutputOptions } from 'rollup';\nimport { mergeConfig, UserConfig } from 'vite';\n\nexport function mergeOptions<T extends Record<string, any> = Record<string, any>>(\n  base: T,\n  ...overrides: (OverrideOptions<T> | undefined)[]\n): T {\n  if (!overrides.length) {\n    return base;\n  }\n\n  for (const override of overrides) {\n    if (!override) {\n      continue;\n    }\n\n    if (typeof override === 'function') {\n      base = override(base) ?? base;\n    } else {\n      // @ts-ignore\n      base = mergeConfig(base, override);\n    }\n  }\n\n  return base;\n}\n\nexport function appendMinFileName(output: OutputOptions): OutputOptions {\n  output = cloneDeep(output);\n\n  if (output.file) {\n    const parts = output.file.split('.');\n    const ext = parts.pop();\n    output.file = `${parts.join('.')}.min.${ext}`;\n  } else if (output.dir && typeof output.entryFileNames === 'string') {\n    const parts = output.entryFileNames.split('.');\n    const ext = parts.pop();\n    output.entryFileNames = `${parts.join('.')}.min.${ext}`;\n  }\n\n  return output;\n}\n\nexport function show(data: any, depth = 10) {\n  console.log(inspect(data, { depth, colors: true }));\n}\n","import BuildTask from '@/builder/BuildTask.ts';\nimport { FileTasks, FusionVitePluginOptions, LinkOptions, RunnerCliParams } from '@/types';\nimport { show } from '@/utilities/utilities.ts';\nimport { get, set } from 'lodash-es';\nimport { isAbsolute, relative } from 'node:path';\nimport { NormalizedOutputOptions, OutputBundle, PreRenderedAsset, PreRenderedChunk, RollupOptions } from 'rollup';\nimport { MaybePromise } from '@/types';\nimport { ConfigEnv, mergeConfig, PluginOption, UserConfig, Plugin } from 'vite';\n\nexport default class ConfigBuilder {\n  static globalOverrideConfig: UserConfig = {};\n  overrideConfig: UserConfig = {};\n\n  entryFileNamesCallbacks: ((chunkInfo: PreRenderedChunk) => string | undefined | void)[] = [];\n  chunkFileNamesCallbacks: ((chunkInfo: PreRenderedChunk) => string | undefined | void)[] = [];\n  assetFileNamesCallbacks: ((chunkInfo: PreRenderedAsset) => string | undefined | void)[] = [];\n\n  moveTasks: FileTasks = [];\n  copyTasks: FileTasks = [];\n  linkTasks: FileTasks<'link'> = [];\n  postBuildCallbacks: ((options: NormalizedOutputOptions, bundle: OutputBundle) => MaybePromise<void>)[] = [];\n  resolveIdCallbacks: Exclude<Plugin['resolveId'], undefined>[] = [];\n  loadCallbacks: Exclude<Plugin['load'], undefined>[] = [];\n  // fileNameMap: Record<string, string> = {};\n\n  // externals: ((source: string, importer: string | undefined, isResolved: boolean) => boolean | string | NullValue)[] = [];\n  watches: string[] = [];\n  cleans: string[] = [];\n\n  tasks: Map<string, BuildTask> = new Map();\n\n  constructor(public config: UserConfig, public env: ConfigEnv, public fusionOptions: FusionVitePluginOptions) {\n    // this.ensurePath('build', {});\n    // this.ensurePath('build.rollupOptions', {\n    //   input: {},\n    //   output: this.getDefaultOutput(),\n    // });\n    // this.ensurePath('plugins', []);\n\n    this.config = mergeConfig<UserConfig, UserConfig>(this.config, {\n      build: {\n        manifest: 'manifest.json',\n        rollupOptions: {\n          preserveEntrySignatures: 'strict',\n          input: {},\n          output: this.getDefaultOutput(),\n          // external: (source: string, importer: string | undefined, isResolved: boolean) => {\n          //   for (const external of this.externals) {\n          //     const result = external(source, importer, isResolved);\n          //\n          //     if (result) {\n          //       return true;\n          //     }\n          //   }\n          // },\n        },\n        emptyOutDir: false,\n        sourcemap: env.mode !== 'production' ? 'inline' : false,\n      },\n      plugins: [],\n      css: {\n        devSourcemap: true,\n      },\n      esbuild: {\n        // Todo: Remove if esbuild supports decorators by default\n        target: 'es2022',\n      }\n    });\n\n    this.addTask('hidden:placeholder');\n  }\n\n  merge(override: UserConfig | ((config: UserConfig) => UserConfig)) {\n    if (typeof override === 'function') {\n      this.config = override(this.config) ?? this.config;\n\n      return this;\n    }\n\n    this.config = mergeConfig(this.config, override);\n\n    return this;\n  }\n\n  private getDefaultOutput(): RollupOptions['output'] {\n    return {\n      entryFileNames: (chunkInfo) => {\n        const name = this.getChunkNameFromTask(chunkInfo);\n\n        if (name) {\n          return name;\n        }\n\n        for (const entryFileNamesCallback of this.entryFileNamesCallbacks) {\n          const name = entryFileNamesCallback(chunkInfo);\n\n          if (name) {\n            return name;\n          }\n        }\n\n        // console.log(chunkInfo, this.relativePath(chunkInfo.facadeModuleId));\n\n        return '[name].js';\n      },\n      chunkFileNames: (chunkInfo) => {\n        const name = this.getChunkNameFromTask(chunkInfo);\n\n        if (name) {\n          return name;\n        }\n\n        for (const chunkFileNamesCallback of this.chunkFileNamesCallbacks) {\n          const name = chunkFileNamesCallback(chunkInfo);\n\n          if (name) {\n            return name;\n          }\n        }\n\n        const chunkDir = this.getChunkDir();\n\n        return `${chunkDir}[name]-[hash].js`;\n      },\n      assetFileNames: (assetInfo) => {\n        // if (this.fileNameMap[assetInfo.name]) {\n        //   assetInfo.name = this.fileNameMap[assetInfo.name];\n        //   return assetInfo.name;\n        // }\n\n        for (const assetFileNamesCallback of this.assetFileNamesCallbacks) {\n          const name = assetFileNamesCallback(assetInfo);\n\n          if (name) {\n            return name;\n          }\n        }\n\n        return '[name].[ext]';\n      }\n    };\n  }\n\n  private getChunkDir(): string {\n    let chunkDir = this.fusionOptions.chunkDir ?? 'chunks';\n    chunkDir.replace(/\\\\/g, '/');\n\n    // Ensure trailing slash\n    if (chunkDir && !chunkDir.endsWith('/')) {\n      chunkDir += '/';\n    }\n\n    if (chunkDir === './' || chunkDir === '/') {\n      chunkDir = '';\n    }\n\n    return chunkDir;\n  }\n\n  private getChunkNameFromTask(chunkInfo: PreRenderedChunk) {\n    if (this.tasks.has(chunkInfo.name)) {\n      const output = this.tasks.get(chunkInfo.name)?.output;\n\n      if (output) {\n        const name = typeof output === 'function' ? output(chunkInfo) : output;\n\n        if (!isAbsolute(name)) {\n          return name;\n        }\n      }\n    }\n\n    return undefined;\n  }\n\n  ensurePath(path: string, def: any = {}) {\n    if (get(this.config, path) == null) {\n      set(this.config, path, def);\n    }\n\n    return this;\n  }\n\n  get(path: string) {\n    return get(this.config, path);\n  }\n\n  set(path: string, value: any) {\n    set(this.config, path, value);\n    return this;\n  }\n\n  addTask(input: string, group?: string) {\n    const task = new BuildTask(input, group);\n\n    this.tasks.set(task.id, task);\n\n    const inputOptions = this.config.build!.rollupOptions!.input! as Record<string, string>;\n    inputOptions[task.id] = task.input;\n\n    return task;\n  }\n\n  addCleans(...paths: string[]) {\n    this.cleans.push(...paths);\n\n    return this;\n  }\n\n  // addExternals(externals: Externalize) {\n  //   if (Array.isArray(externals)) {\n  //     this.externals.push((rollupOptions) => {\n  //       rollupOptions.external\n  //     })\n  //   } else if (typeof externals === 'object') {\n  //\n  //   } else {\n  //\n  //   }\n  // }\n\n  // addPlugin(plugin: PluginOption) {\n  //   this.config.plugins?.push(plugin);\n  // }\n  //\n  // removePlugin(plugin: string | PluginOption) {\n  //   this.config.plugins = this.config.plugins?.filter((p) => {\n  //     if (!p) {\n  //       return true;\n  //     }\n  //\n  //     if (typeof plugin === 'string' && typeof p === 'object' && 'name' in p) {\n  //       return p.name !== plugin;\n  //     } else if (typeof plugin === 'object' && typeof p === 'object') {\n  //       return p !== plugin;\n  //     }\n  //\n  //     return true;\n  //   });\n  // }\n\n  relativePath(to: string) {\n    return relative(process.cwd(), to);\n  }\n\n  debug() {\n    show(this.config);\n  }\n}\n","import { RunnerCliParams } from '@/types/runner.ts';\nimport yargs from 'yargs';\n\nexport function getArgsAfterDoubleDashes(argv?: string[]): string[] {\n  argv ??= process.argv;\n\n  return argv.slice(2).join(' ')\n    // Split by -- and remove the first part\n    .split(' -- ').slice(1)\n    // Join back and split by space\n    .join(' -- ').trim()\n    // Split back to array and remove empty values\n    .split(' ').filter(v => v !== '');\n}\n\nexport function parseArgv(argv: string[]): RunnerCliParams {\n  const app = yargs();\n\n  // app.option('watch', {\n  //   alias: 'w',\n  //   type: 'boolean',\n  //   description: 'Watch files for changes and re-run the tasks',\n  // });\n\n  app.option('cwd', {\n    type: 'string',\n    description: 'Current working directory',\n  });\n\n  app.option('list', {\n    alias: 'l',\n    type: 'boolean',\n    description: 'List all available tasks',\n  });\n\n  app.option('config', {\n    alias: 'c',\n    type: 'string',\n    description: 'Path to config file',\n  });\n\n  app.option('server-file', {\n    alias: 's',\n    type: 'string',\n    description: 'Path to server file',\n  });\n\n  // app.option('series', {\n  //   alias: 's',\n  //   type: 'boolean',\n  //   description: 'Run tasks in series instead of parallel',\n  // });\n\n  app.option('verbose', {\n    alias: 'v',\n    type: 'count',\n    description: 'Increase verbosity of output. Use multiple times for more verbosity.',\n  });\n\n  return app.parseSync(argv);\n}\n","import { ProcessorInterface } from '@/processors/ProcessorInterface.ts';\r\nimport { forceArray } from '@/utilities/arr.ts';\r\nimport { build } from 'esbuild';\r\nimport Module from 'module';\r\nimport { existsSync, writeFileSync } from 'node:fs';\r\nimport { dirname, isAbsolute, resolve } from 'node:path';\r\nimport { MaybeArray, MaybePromise } from '@/types';\r\nimport { ConfigResult, LoadedConfigTask, RunnerCliParams } from '@/types';\r\n\r\nexport async function loadConfigFile(configFile: ConfigResult): Promise<Record<string, LoadedConfigTask>> {\r\n  let path = configFile.path;\r\n\r\n  // If is Windows, Add \"file://\" prefix to path\r\n  if (process.platform === 'win32') {\r\n    // todo: try use pathToFileURL(): import { pathToFileURL } from 'url';\r\n    // Replace backslash to slash\r\n    const winPath = path.replace(/\\\\/g, '/');\r\n    // Add file:// prefix if not exists\r\n    if (!winPath.startsWith('file://')) {\r\n      // Add extra slash to make it absolute path\r\n      // e.g. C:/path/to/file\r\n      // becomes file:///C:/path/to/file\r\n      path = `file:///${winPath}`;\r\n    }\r\n  }\r\n\r\n  if (configFile.ts) {\r\n    const buildResult = await build({\r\n      entryPoints: [configFile.path],\r\n      bundle: true,\r\n      write: false,\r\n      outdir: 'dist',\r\n      platform: 'node',\r\n      format: 'cjs',\r\n      target: 'esnext',\r\n      external: ['../dist', '../dist/*'],\r\n      packages: 'external',\r\n      sourcemap: 'inline',\r\n    });\r\n    \r\n    const output = buildResult.outputFiles[0];\r\n\r\n    const code = Buffer.from(output.contents).toString('utf8');\r\n    writeFileSync(output.path, code);\r\n    const m = new Module(output.path, undefined);\r\n    m.filename = output.path;\r\n    // @ts-ignore\r\n    m.paths = Module._nodeModulePaths(dirname(output.path));\r\n    // @ts-ignore\r\n    m._compile(code, output.path);\r\n\r\n    return expandModules(m.exports);\r\n  } else {\r\n    const modules = await import(path);\r\n\r\n    return expandModules(modules);\r\n  }\r\n}\r\n\r\nexport function expandModules(modules: Record<string, any>) {\r\n  modules = { ...modules };\r\n\r\n  if (modules.__esModule) {\r\n    delete modules.__esModule;\r\n  }\r\n\r\n  return modules;\r\n}\r\n\r\nexport async function resolveTaskResults(task: LoadedConfigTask) {\r\n  task = await task;\r\n\r\n  return Promise.all(forceArray(task));\r\n}\r\n\r\nexport async function resolveTaskOptions(task: LoadedConfigTask, resolveSubFunctions = false): Promise<ProcessorInterface[]> {\r\n  task = await task;\r\n\r\n  if (!resolveSubFunctions && Array.isArray(task)) {\r\n    const results = await Promise.all(task.map((task) => resolveTaskOptions(task, true)));\r\n    return results.flat();\r\n  }\r\n\r\n  if (typeof task === 'function') {\r\n    return resolvePromisesToFlatArray(await task() as any, task?.name);\r\n  }\r\n\r\n  return resolvePromisesToFlatArray((await task) as MaybeArray<ProcessorInterface>, (task as any)?.name);\r\n}\r\n\r\nasync function resolvePromisesToFlatArray(tasks: MaybeArray<MaybePromise<ProcessorInterface>>, name?: string) {\r\n  if (!Array.isArray(tasks)) {\r\n    return [await tasks];\r\n  }\r\n\r\n  const resolvedTasks = await Promise.all(tasks);\r\n  const returnTasks = [];\r\n\r\n  for (const resolvedTask of resolvedTasks) {\r\n    if (Array.isArray(resolvedTask)) {\r\n      returnTasks.push(...resolvedTask);\r\n    } else {\r\n      returnTasks.push(resolvedTask);\r\n    }\r\n  }\r\n\r\n  return returnTasks;\r\n}\r\n\r\nexport function mustGetAvailableConfigFile(root: string, params: RunnerCliParams): ConfigResult {\r\n  const found = getAvailableConfigFile(root, params);\r\n\r\n  if (!found) {\r\n    throw new Error('No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.');\r\n  }\r\n\r\n  return found;\r\n}\r\n\r\nexport function getAvailableConfigFile(root: string, params: RunnerCliParams): ConfigResult | null {\r\n  let found = params?.config;\r\n\r\n  if (found) {\r\n    // If is not absolute of system path(consider Windows), prepend root\r\n    if (!isAbsolute(found)) {\r\n      found = resolve(root, found);\r\n    }\r\n\r\n    if (existsSync(found)) {\r\n      return {\r\n        path: found,\r\n        // get filename from file path\r\n        filename: found.split('/').pop() || '',\r\n        type: getConfigModuleType(found),\r\n        ts: isConfigTypeScript(found),\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  return findDefaultConfig(root);\r\n}\r\n\r\nexport function findDefaultConfig(root: string): ConfigResult | null {\r\n  let file = resolve(root, 'fusionfile.js');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'commonjs',\r\n      ts: false,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.mjs');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: false,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.ts');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: true,\r\n    };\r\n  }\r\n\r\n  file = resolve(root, 'fusionfile.mts');\r\n\r\n  if (existsSync(file)) {\r\n    return {\r\n      path: file,\r\n      // get filename from file path\r\n      filename: file.split('/').pop() || '',\r\n      type: 'module',\r\n      ts: true,\r\n    };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction getConfigModuleType(file: string) {\r\n  let type: 'commonjs' | 'module' | 'unknown' = 'unknown';\r\n\r\n  if (file.endsWith('.cjs')) {\r\n    type = 'commonjs';\r\n  } else if (file.endsWith('.mjs')) {\r\n    type = 'module';\r\n  } else if (file.endsWith('.ts') || file.endsWith('.mts')) {\r\n    type = 'module';\r\n  }\r\n\r\n  return type;\r\n}\r\n\r\nfunction isConfigTypeScript(file: string) {\r\n  return file.endsWith('.ts') || file.endsWith('.mts');\r\n}\r\n","import { ProcessorInterface, ProcessorPreview } from '@/processors/ProcessorInterface.ts';\r\nimport { LoadedConfigTask } from '@/types';\r\nimport { forceArray } from '@/utilities/arr.ts';\r\nimport archy, { type Data } from 'archy';\r\nimport chalk from 'chalk';\r\nimport { MaybeArray } from 'rollup';\r\nimport { UserConfig } from 'vite';\r\nimport { resolveTaskOptions } from './config';\r\n\r\nexport async function displayAvailableTasks(tasks: Record<string, LoadedConfigTask>) {\r\n  const keys = Object.keys(tasks);\r\n\r\n  // Sort put default as first if exists\r\n  keys.sort((a, b) => {\r\n    if (a === 'default') {\r\n      return -1;\r\n    }\r\n\r\n    if (b === 'default') {\r\n      return 1;\r\n    }\r\n\r\n    return a.localeCompare(b);\r\n  });\r\n\r\n  const nodes: Array<Data | string> = [];\r\n\r\n  for (const key of keys) {\r\n    const task = tasks[key];\r\n    // const taskOptions = await resolveTaskOptions(task, true);\r\n\r\n    nodes.push(await describeTasks(key, task));\r\n  }\r\n\r\n  const text = archy({\r\n    label: chalk.magenta('Available Tasks'),\r\n    nodes\r\n  });\r\n\r\n  console.log(text);\r\n}\r\n\r\nasync function describeTasks(name: string, tasks: LoadedConfigTask): Promise<Data> {\r\n  const nodes = [];\r\n  tasks = forceArray(await tasks);\r\n\r\n  for (let task of tasks) {\r\n    const processors = await resolveTaskOptions(task, true);\r\n\r\n    for (const processor of processors) {\r\n      if (typeof processor === 'function') {\r\n        nodes.push(\r\n          await describeTasks((processor as Function).name, processor)\r\n        );\r\n      } else {\r\n        nodes.push(...await describeProcessor(processor));\r\n      }\r\n    }\r\n  }\r\n\r\n  return {\r\n    label: chalk.cyan(name),\r\n    nodes\r\n  };\r\n}\r\n\r\nasync function describeProcessor(processor: ProcessorInterface): Promise<string[]> {\r\n  const results = await processor.preview();\r\n\r\n  return Promise.all(results.map((result) => describeProcessorPreview(result)));\r\n}\r\n\r\nasync function describeProcessorPreview(preview: ProcessorPreview): Promise<string> {\r\n  const str = [];\r\n\r\n  const { input: entry, output, extra } = preview;\r\n\r\n  // Input\r\n  const inputStr = chalk.yellow(entry);\r\n  // if (typeof entry === 'string') {\r\n  //   inputStr = chalk.yellow(entry);\r\n  // } else if (Array.isArray(entry)) {\r\n  //   inputStr = chalk.yellow(entry.join(', '));\r\n  // } else if (typeof entry === 'object') {\r\n  //   inputStr = chalk.yellow(Object.values(entry).join(', '));\r\n  // }\r\n  str.push(`Input: ${inputStr}`);\r\n\r\n  // Output\r\n  // if (output) {\r\n  //   const outputs = Array.isArray(output) ? output : [output];\r\n  //   outputs.forEach((output, index) => {\r\n  //     let outStr = '';\r\n  //     if (output.file) {\r\n  //       outStr = chalk.green(output.file);\r\n  //     } else if (output.dir) {\r\n  //       outStr = chalk.green(output.dir);\r\n  //     }\r\n  //     str.push(`Output[${index}]: ${outStr}`);\r\n  //   });\r\n  // }\r\n\r\n  const outStr = chalk.green(output);\r\n  str.push(`Output: ${outStr}`);\r\n\r\n  return str.join(\" - \");\r\n}\r\n\r\nfunction countTask(task: MaybeArray<UserConfig>) {\r\n  if (Array.isArray(task)) {\r\n    return task.length;\r\n  }\r\n\r\n  return 1;\r\n}\r\n","import { ProcessorInterface } from '@/processors/ProcessorInterface.ts';\r\nimport chalk from 'chalk';\r\nimport { uniq } from 'lodash-es';\r\nimport { MaybeArray } from 'rollup';\r\nimport { resolveTaskOptions } from '@/runner/config';\r\nimport { LoadedConfigTask, RunningTasks } from '@/types/runner.ts';\r\nimport { UserConfig } from 'vite';\r\n\r\nexport function selectRunningTasks(\r\n  input: string[],\r\n  tasks: Record<string, LoadedConfigTask>\r\n): Record<string, LoadedConfigTask> {\r\n  input = uniq(input);\r\n\r\n  if (input.length === 0) {\r\n    input.push('default');\r\n  }\r\n\r\n  const selected: Record<string, LoadedConfigTask> = {};\r\n\r\n  for (const name of input) {\r\n    if (tasks[name]) {\r\n      selected[name] = tasks[name];\r\n    } else {\r\n      throw new Error(`Task \"${chalk.cyan(name)}\" not found in fusion config.`);\r\n    }\r\n  }\r\n\r\n  return selected;\r\n}\r\n\r\nexport async function resolveAllTasksAsProcessors(tasks: Record<string, LoadedConfigTask>): Promise<RunningTasks> {\r\n  const cache: Record<string, MaybeArray<LoadedConfigTask>> = {};\r\n  const allTasks: RunningTasks = {};\r\n\r\n  for (const name in tasks) {\r\n    const task = tasks[name];\r\n\r\n    allTasks[name] = (await resolveTaskAsFlat(name, task, cache));\r\n  }\r\n\r\n  return allTasks;\r\n}\r\n\r\nexport async function resolveTaskAsFlat(\r\n  name: string,\r\n  task: LoadedConfigTask,\r\n  cache: Record<string, MaybeArray<LoadedConfigTask>>\r\n): Promise<ProcessorInterface[]> {\r\n  const results: ProcessorInterface[] = [];\r\n\r\n  if (Array.isArray(task)) {\r\n    for (const n in task) {\r\n      const t = task[n];\r\n      results.push(...await resolveTaskAsFlat(n, t, cache));\r\n    }\r\n  } else if (typeof task === 'function') {\r\n    name = task.name || name;\r\n\r\n    if (cache[name]) {\r\n      return [];\r\n    }\r\n\r\n    cache[name] = task;\r\n\r\n    const resolved = await resolveTaskOptions(task, true);\r\n\r\n    if (Array.isArray(resolved)) {\r\n      for (const n in resolved) {\r\n        const t = resolved[n];\r\n        results.push(...await resolveTaskAsFlat(n, t, cache));\r\n      }\r\n    }\r\n  } else {\r\n    results.push(await task);\r\n  }\r\n\r\n  return results;\r\n}\r\n","export * from '@/dep';\nimport * as fusion from '@/dep';\nimport ConfigBuilder from '@/builder/ConfigBuilder.ts';\nimport { prepareParams } from '@/params';\nimport { getArgsAfterDoubleDashes, parseArgv } from '@/runner/app';\nimport { expandModules, loadConfigFile, mustGetAvailableConfigFile } from '@/runner/config';\nimport { displayAvailableTasks } from '@/runner/describe.ts';\nimport { resolveAllTasksAsProcessors, selectRunningTasks } from '@/runner/tasks.ts';\nimport { FusionPlugin, FusionVitePluginOptions, FusionVitePluginUnresolved, LoadedConfigTask } from '@/types';\nimport { forceArray } from '@/utilities/arr.ts';\nimport { cleanFiles, copyFilesAndLog, linkFilesAndLog, moveFilesAndLog } from '@/utilities/fs.ts';\nimport { mergeOptions, show } from '@/utilities/utilities.ts';\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport { uniq } from 'lodash-es';\nimport { existsSync, writeFileSync } from 'node:fs';\nimport { relative, resolve } from 'node:path';\nimport micromatch from 'micromatch';\nimport { Logger, mergeConfig, PluginOption, ResolvedConfig, UserConfig } from 'vite';\n\nlet params = parseArgv(getArgsAfterDoubleDashes(process.argv));\nprepareParams(params);\n\nexport let builder: ConfigBuilder;\n\nconst originalTasks = params._;\nconst extraVitePlugins: FusionPlugin[] = [];\n\nexport function useFusion(fusionOptions: FusionVitePluginUnresolved = {}, tasks?: string | string[]): PluginOption {\n  let logger: Logger;\n  let resolvedConfig: ResolvedConfig;\n  let exitHandlersBound = false;\n\n  const resolvedOptions = prepareFusionOptions(fusionOptions);\n\n  if (\n    typeof tasks === 'string'\n    || (Array.isArray(tasks) && tasks.length > 0)\n  ) {\n    params._ = forceArray(tasks);\n  } else {\n    params._ = originalTasks;\n  }\n\n  params = mergeOptions(params, resolvedOptions.cliParams);\n\n  return [\n    {\n      name: 'fusion',\n      configResolved(config) {\n        resolvedConfig = config;\n\n        logger = config.logger;\n\n        // @ts-ignore\n        config.plugins.push(...extraVitePlugins);\n\n        for (const plugin of (config.plugins as FusionPlugin[])) {\n          if ('buildConfig' in plugin) {\n            plugin.buildConfig?.(builder);\n          }\n        }\n      },\n      async config(config, env) {\n        let root: string;\n\n        if (config.root) {\n          root = resolve(config.root);\n        } else {\n          root = params.cwd || process.cwd();\n        }\n\n        delete config.root;\n        // delete builder.config.root;\n\n        process.chdir(root);\n\n        builder = new ConfigBuilder(config, env, resolvedOptions);\n\n        // Retrieve config file\n        let tasks: Record<string, LoadedConfigTask>;\n\n        if (typeof resolvedOptions.fusionfile === 'string' || !resolvedOptions.fusionfile) {\n          params.config ??= resolvedOptions.fusionfile;\n          const configFile = mustGetAvailableConfigFile(root, params);\n\n          // Load config\n          tasks = await loadConfigFile(configFile);\n        } else if (typeof resolvedOptions.fusionfile === 'function') {\n          tasks = expandModules(await resolvedOptions.fusionfile());\n        } else {\n          tasks = expandModules(resolvedOptions.fusionfile);\n        }\n\n        // Describe tasks\n        if (params.list) {\n          await displayAvailableTasks(tasks);\n          return;\n        }\n\n        // Select running tasks\n        const selectedTasks = selectRunningTasks([...params._] as string[], tasks);\n\n        const runningTasks = (await resolveAllTasksAsProcessors(selectedTasks));\n\n        for (const taskName in runningTasks) {\n          const processors = runningTasks[taskName];\n\n          for (const processor of processors) {\n            await processor.config(taskName, builder);\n          }\n        }\n\n        builder.merge(ConfigBuilder.globalOverrideConfig);\n        builder.merge(builder.overrideConfig);\n\n        // for (const plugin of plugins) {\n        //   if (plugin.buildConfig) {\n        //     await plugin.buildConfig(builder, env);\n        //   }\n        // }\n\n        // console.log('plugin bottom', builder.config);\n        //\n        // show(builder.overrideConfig, 15)\n        // show(builder.config, 15)\n\n        return builder.config;\n      },\n      outputOptions(options) {\n        // Protect upload folder\n        if (resolvedConfig.build.emptyOutDir) {\n          const dir = resolvedConfig.build.outDir;\n          const uploadDir = resolve(dir, 'upload');\n\n          if (existsSync(uploadDir)) {\n            throw new Error(\n              `The output directory: \"${dir}\" contains an \"upload\" folder, please move this folder away or set an different fusion outDir.`\n            );\n          }\n        }\n      },\n      async buildStart(options) {\n        if (builder.cleans.length > 0) {\n          await cleanFiles(builder.cleans, resolvedConfig.build.outDir || process.cwd());\n        }\n      },\n\n      // Server\n      configureServer(server) {\n        server.httpServer?.once('listening', () => {\n          // Build listening Host\n          const scheme = server.config.server.https ? 'https' : 'http';\n          const address = server.httpServer?.address();\n          const host = address && typeof address !== 'string' ? address.address : 'localhost';\n          const port = address && typeof address !== 'string' ? address.port : 80;\n\n          const url = `${scheme}://${host}:${port}/`;\n\n          // Build & write server file\n          const serverFile = resolve(\n            server.config.root,\n            resolvedOptions.cliParams?.serverFile ?? 'tmp/vite-server'\n          );\n\n          writeFileSync(resolve(server.config.root, serverFile), url);\n\n          // Bind exit signals\n          if (!exitHandlersBound) {\n            process.on(\"exit\", () => {\n              if (fs.existsSync(serverFile)) {\n                fs.rmSync(serverFile);\n              }\n            });\n            process.on(\"SIGINT\", () => process.exit());\n            process.on(\"SIGTERM\", () => process.exit());\n            process.on(\"SIGHUP\", () => process.exit());\n            exitHandlersBound = true;\n          }\n        });\n\n        const watches = builder.watches.map((p) => resolve(p).replace(/\\\\/g, '/'));\n\n        server.watcher.add(watches);\n\n        const checkReload = (path: string) => {\n          if (micromatch.isMatch(path, watches)) {\n            server.ws.send({ type: 'full-reload', path: '*' });\n\n            logger.info(\n              `${chalk.green('full reload')} ${chalk.dim(relative(process.cwd(), path))}`,\n              { timestamp: true }\n            )\n          }\n        };\n\n        server.watcher.on('add', checkReload);\n        server.watcher.on('change', checkReload);\n      },\n      // async handleHotUpdate(ctx) {\n      //   if (builder.watches.includes(ctx.file)) {\n      //     if (ctx.modules.length > 0) {\n      //       return ctx.modules;\n      //     }\n      //\n      //     const modules = ctx.server.moduleGraph.getModulesByFile(ctx.file);\n      //\n      //     if (modules) {\n      //       return [...modules];\n      //     }\n      //\n      //     // const resolved = await ctx.server.pluginContainer.resolveId(ctx.file);\n      //     // if (resolved) {\n      //     //   const vm = server.moduleGraph.getModuleById(resolved.id) || server.moduleGraph.getModuleById(virtualPrefixId)\n      //     //   if (vm) {\n      //     //     return [vm]\n      //     //   }\n      //     // }\n      //\n      //     ctx.server.ws.send({ type: 'full-reload', path: '*' })\n      //\n      //     return [];\n      //   }\n      // }\n    },\n    {\n      name: 'fusion:pre-handles',\n      enforce: 'pre',\n      async resolveId(source, importer, options) {\n        for (const resolveId of builder.resolveIdCallbacks) {\n          if (typeof resolveId !== 'function') {\n            continue;\n          }\n\n          const result = await resolveId.call(this, source, importer, options);\n\n          if (result) {\n            return result;\n          }\n        }\n\n        if (source.startsWith('hidden:')) {\n          return source;\n        }\n      },\n      async load(source, options) {\n        for (const load of builder.loadCallbacks) {\n          if (typeof load !== 'function') {\n            continue;\n          }\n\n          const result = await load.call(this, source, options);\n\n          if (result) {\n            return result;\n          }\n        }\n\n        if (source.startsWith('hidden:')) {\n          return '';\n        }\n      },\n    },\n    {\n      name: 'fusion:post-handles',\n      generateBundle(options, bundle) {\n        for (const [fileName, chunk] of Object.entries(bundle)) {\n          if (chunk.type === 'chunk' && chunk.facadeModuleId?.startsWith('hidden:')) {\n            delete bundle[fileName];\n          }\n        }\n      },\n      async writeBundle(options, bundle) {\n        const outDir = resolvedConfig.build.outDir || process.cwd();\n\n        // Todo: override logger to replace vite's files logs\n        // @see https://github.com/windwalker-io/core/issues/1355\n        await moveFilesAndLog(builder.moveTasks, outDir, logger);\n        await copyFilesAndLog(builder.copyTasks, outDir, logger);\n        await linkFilesAndLog(builder.linkTasks, outDir, logger);\n\n        for (const callback of builder.postBuildCallbacks) {\n          await callback(options, bundle);\n        }\n\n        for (const [name, task] of builder.tasks) {\n          for (const callback of task.postCallbacks) {\n            await callback(options, bundle);\n          }\n        }\n      },\n    },\n  ];\n}\n\nfunction prepareFusionOptions(options: FusionVitePluginUnresolved): FusionVitePluginOptions {\n  if (typeof options === 'string') {\n    return {\n      fusionfile: options,\n    };\n  }\n\n  if (typeof options === 'function') {\n    return {\n      fusionfile: options,\n    };\n  }\n\n  return options;\n}\n\nexport function configureBuilder(handler: (builder: ConfigBuilder) => void) {\n  handler(builder);\n}\n\nexport function mergeViteConfig(config: UserConfig | null) {\n  // if (config === null) {\n  //   ConfigBuilder.globalOverrideConfig = {};\n  //   return;\n  // }\n  //\n  // ConfigBuilder.globalOverrideConfig = mergeConfig(ConfigBuilder.globalOverrideConfig, config);\n  if (config === null) {\n    builder.overrideConfig = {};\n    return;\n  }\n\n  builder.overrideConfig = mergeConfig(builder.overrideConfig, config);\n}\n\nexport function outDir(outDir: string) {\n  // ConfigBuilder.globalOverrideConfig = mergeConfig<UserConfig, UserConfig>(ConfigBuilder.globalOverrideConfig, {\n  //   build: {\n  //     outDir\n  //   }\n  // });\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\n    build: {\n      outDir\n    }\n  });\n}\n\nexport function chunkDir(dir: string) {\n  builder.fusionOptions.chunkDir = dir;\n}\n\nexport function alias(src: string, dest: string) {\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\n    resolve: {\n      alias: {\n        [src]: dest\n      }\n    }\n  });\n}\n\nexport function external(match: string, varName?: string) {\n  const globals: Record<string, string> = {};\n\n  if (varName) {\n    globals[match] = varName;\n  }\n\n  builder.overrideConfig = mergeConfig<UserConfig, UserConfig>(builder.overrideConfig, {\n    build: {\n      rollupOptions: {\n        external: [match],\n        output: {\n          globals\n        }\n      }\n    }\n  });\n}\n\nexport function plugin(...plugins: FusionPlugin[]) {\n  extraVitePlugins.push(...plugins);\n}\n\nexport function clean(...paths: string[]) {\n  builder.addCleans(...paths);\n\n  builder.cleans = uniq(builder.cleans);\n}\n\nexport function fullReloads(...paths: string[]) {\n  builder.watches.push(...paths);\n\n  builder.watches = uniq(builder.watches);\n}\n\nexport default {\n  ...fusion,\n  useFusion,\n  configureBuilder,\n  mergeViteConfig,\n  outDir,\n  chunkDir,\n  alias,\n  external,\n  plugin,\n  clean,\n  fullReloads,\n  params,\n};\n"],"names":["forceArray","item","handleMaybeArray","items","callback","handleForceArray","css","input","output","options","CssProcessor","taskName","builder","task","assetInfo","name","basename","parse","js","JsProcessor","chunkInfo","move","dest","MoveProcessor","copy","CopyProcessor","link","LinkProcessor","handler","CallbackProcessor","callbackAfterBuild","afterBuild","params","prepareParams","p","isVerbose","isProd","isDev","isWindows","shortHash","bufferOrString","short","hash","Crypto","handleFilesOperation","src","promises","normalizeFilePath","base","getGlobBaseFromPattern","sources","isGlob","fg","source","dir","resolvedDest","endsWithSlash","relative","dirname","fs","moveFilesAndLog","tasks","outDir","logger","ps","copyFilesAndLog","linkFilesAndLog","symlink","cleanFiles","patterns","resolve","protectDir","copyGlob","moveGlob","target","force","path","pattern","specialChars","idx","c","isAbsolute","fileToId","group","normalize","randomBytes","BuildTask","ext","mergeOptions","overrides","override","mergeConfig","show","data","depth","inspect","ConfigBuilder","config","env","fusionOptions","entryFileNamesCallback","chunkFileNamesCallback","assetFileNamesCallback","chunkDir","def","get","set","value","inputOptions","paths","to","getArgsAfterDoubleDashes","argv","v","parseArgv","app","yargs","loadConfigFile","configFile","winPath","build","code","writeFileSync","m","Module","expandModules","modules","resolveTaskOptions","resolveSubFunctions","resolvePromisesToFlatArray","resolvedTasks","returnTasks","resolvedTask","mustGetAvailableConfigFile","root","found","getAvailableConfigFile","existsSync","getConfigModuleType","isConfigTypeScript","findDefaultConfig","file","type","displayAvailableTasks","keys","a","b","nodes","key","describeTasks","text","archy","chalk","processors","processor","describeProcessor","results","result","describeProcessorPreview","preview","str","entry","extra","inputStr","outStr","selectRunningTasks","uniq","selected","resolveAllTasksAsProcessors","cache","allTasks","resolveTaskAsFlat","n","t","resolved","originalTasks","extraVitePlugins","useFusion","resolvedConfig","exitHandlersBound","resolvedOptions","prepareFusionOptions","plugin","selectedTasks","runningTasks","uploadDir","server","scheme","address","host","port","url","serverFile","watches","checkReload","micromatch","importer","resolveId","load","bundle","fileName","chunk","configureBuilder","mergeViteConfig","alias","external","match","varName","globals","plugins","clean","fullReloads","index","fusion"],"mappings":"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"}