"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const V=require("crypto"),W=require("fast-glob"),p=require("fs-extra"),H=require("node:crypto"),a=require("node:path"),U=require("node:util"),y=require("vite"),v=require("lodash-es"),J=require("yargs"),K=require("esbuild"),x=require("module"),m=require("node:fs"),Q=require("archy"),w=require("chalk"),D=require("fs");function g(t){return Array.isArray(t)?t:[t]}function A(t,e){return Array.isArray(t)?t.map(e):e(t)}function q(t,e){return t=g(t),t.map(e)}function X(t,e,s={}){return new Y(t,e,s)}class Y{constructor(e,s,n={}){this.input=e,this.output=s,this.options=n}config(e,s){return q(this.input,n=>{const i=s.addTask(n,e);return s.assetFileNamesCallbacks.push(r=>{const o=r.names[0];if(o&&a.basename(o,".css")===i.id)return this.output?i.normalizeOutput(this.output,".css"):a.parse(n).name+".css"}),i})}preview(){return g(this.input).map(e=>({input:e,output:this.output||a.basename(e),extra:{}}))}}function Z(t,e){return new ee(t,e)}class ee{constructor(e,s){this.input=e,this.output=s}config(e,s){return q(this.input,n=>{const i=s.addTask(n,e);return s.entryFileNamesCallbacks.push(r=>{const o=r.name;if(o&&o===i.id)return this.output?i.normalizeOutput(this.output):a.parse(n).name+".js"}),i})}preview(){return g(this.input).map(e=>({input:e,output:this.output||a.basename(e),extra:{}}))}}function te(t,e){return new se(t,e)}class se{constructor(e,s){this.input=e,this.dest=s}config(e,s){A(this.input,n=>{s.moveTasks.push({src:n,dest:this.dest,options:{}})})}preview(){return g(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function ne(t,e){return new ie(t,e)}class ie{constructor(e,s){this.input=e,this.dest=s}config(e,s){A(this.input,n=>{s.copyTasks.push({src:n,dest:this.dest,options:{}})})}preview(){return g(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function re(t,e,s={}){return new oe(t,e,s)}class oe{constructor(e,s,n={}){this.input=e,this.dest=s,this.options=n}config(e,s){A(this.input,n=>{s.linkTasks.push({src:n,dest:this.dest,options:this.options})})}preview(){return g(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function le(t){return new B(t)}function ae(t){return new B(t,!0)}class B{constructor(e,s=!1){this.handler=e,this.afterBuild=s}config(e,s){this.afterBuild?s.postBuildCallbacks.push(()=>this.handler(e,s)):this.handler(e,s)}preview(){return[]}}exports.params=void 0;function ue(t){return exports.params=t,exports.isVerbose=exports.params?.verbose?exports.params?.verbose>0:!1,t}exports.isVerbose=!1;const $=process.env.NODE_ENV==="production",ce=!$;function F(){return process.platform==="win32"}function _(t,e=8){let s=V.createHash("sha1").update(t).digest("hex");return e&&e>0&&(s=s.substring(0,e)),s}function k(t,e,s){const n=[];t=T(t,s.outDir),e=T(e,s.outDir);const i=be(t),r=I(t)?W.globSync(t.replace(/\\/g,"/"),s.globOptions):[t];for(let o of r){let c,l=e;ye(e)?(c=l,l=l+a.relative(i,o)):c=a.dirname(l),p.ensureDirSync(c),n.push(s.handler(o,l))}return n}function fe(t,e,s){const n=[];for(const{src:i,dest:r,options:o}of t){const c=k(i,r,{outDir:e,handler:async(l,u)=>(s.info(`Moving file from ${a.relative(e,l)} to ${a.relative(e,u)}`),p.move(l,u,{overwrite:!0})),globOptions:{onlyFiles:!0}});n.push(...c)}return Promise.all(n)}function pe(t,e,s){const n=[];for(const{src:i,dest:r,options:o}of t){const c=k(i,r,{outDir:e,handler:async(l,u)=>(s.info(`Copy file from ${a.relative(e,l)} to ${a.relative(e,u)}`),p.copy(l,u,{overwrite:!0})),globOptions:{onlyFiles:!0}});n.push(...c)}return Promise.all(n)}function de(t,e,s){const n=[];for(const{src:i,dest:r,options:o}of t){const c=k(i,r,{outDir:e,handler:async(l,u)=>(s.info(`Link file from ${a.relative(e,l)} to ${a.relative(e,u)}`),M(l,u,o?.force??!1)),globOptions:{onlyFiles:!1}});n.push(...c)}return Promise.all(n)}function he(t,e){const s=[];e=e.replace(/\\/g,"/");for(let n of t){n=T(n,e),n=a.resolve(n);const i=I(n)?W.globSync(n.replace(/\\/g,"/"),{onlyFiles:!1}):[n],r=a.resolve(e+"/upload").replace(/\\/g,"/");for(let o of i){if(o.replace(/\\/g,"/").startsWith(r))throw new Error("Refuse to delete `upload/*` folder.");s.push(p.remove(o))}}return Promise.all(s)}async function me(t,e){const s=k(t,e,{outDir:process.cwd(),handler:async(n,i)=>p.copy(n,i,{overwrite:!0}),globOptions:{onlyFiles:!0}});await Promise.all(s)}async function ge(t,e){const s=k(t,e,{outDir:process.cwd(),handler:async(n,i)=>p.move(n,i,{overwrite:!0}),globOptions:{onlyFiles:!0}});await Promise.all(s)}async function M(t,e,s=!1){return F()&&!p.lstatSync(t).isFile()?p.ensureSymlink(t,e,"junction"):F()&&p.lstatSync(t).isFile()&&s?p.ensureLink(t,e):p.ensureSymlink(t,e)}function ye(t){return t.endsWith("/")||t.endsWith("\\")}function be(t){const e=["*","?","[","]"],s=[...t].findIndex(n=>e.includes(n));return s===-1?a.dirname(t):a.dirname(t.slice(0,s+1))}function I(t){return["*","?","[","]"].some(s=>t.includes(s))}function T(t,e){return t.startsWith(".")?t=a.resolve(t):a.isAbsolute(t)||(t=e+"/"+t),t}function E(t,e){return t=a.normalize(t),e||=H.randomBytes(4).toString("hex"),e+"-"+_(t)}class S{constructor(e,s){this.input=e,this.group=s,this.id=S.toFileId(e,s),this.input=a.normalize(e)}id;output;postCallbacks=[];dest(e){return typeof e=="string"&&(e=this.normalizeOutput(e)),this.output=e,this}addPostCallback(e){return this.postCallbacks.push(e),this}normalizeOutput(e,s=".js"){return(e.endsWith("/")||e.endsWith("\\"))&&(e+=a.parse(this.input).name+s),e}static toFileId(e,s){return E(e,s)}}function ve(t,...e){if(!e.length)return t;for(const s of e)s&&(typeof s=="function"?t=s(t)??t:t=y.mergeConfig(t,s));return t}function we(t,e=10){console.log(U.inspect(t,{depth:e,colors:!0}))}class N{constructor(e,s,n){this.config=e,this.env=s,this.fusionOptions=n,this.config=y.mergeConfig(this.config,{build:{manifest:"manifest.json",rollupOptions:{preserveEntrySignatures:"strict",input:{},output:this.getDefaultOutput()},emptyOutDir:!1,sourcemap:s.mode!=="production"?"inline":!1},plugins:[],css:{devSourcemap:!0},esbuild:{target:"es2022"}}),this.addTask("hidden:placeholder")}static globalOverrideConfig={};overrideConfig={};entryFileNamesCallbacks=[];chunkFileNamesCallbacks=[];assetFileNamesCallbacks=[];moveTasks=[];copyTasks=[];linkTasks=[];postBuildCallbacks=[];resolveIdCallbacks=[];loadCallbacks=[];cleans=[];tasks=new Map;merge(e){return typeof e=="function"?(this.config=e(this.config)??this.config,this):(this.config=y.mergeConfig(this.config,e),this)}getDefaultOutput(){return{entryFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const n of this.entryFileNamesCallbacks){const i=n(e);if(i)return i}return"[name].js"},chunkFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const i of this.chunkFileNamesCallbacks){const r=i(e);if(r)return r}return`${this.getChunkDir()}/[name]-[hash].js`},assetFileNames:e=>{for(const s of this.assetFileNamesCallbacks){const n=s(e);if(n)return n}return"[name].[ext]"}}}getChunkDir(){let e=this.fusionOptions.chunkDir??"chunks";return e.replace(/\\/g,"/"),e&&!e.endsWith("/")&&(e+="/"),(e==="./"||e==="/")&&(e=""),e}getChunkNameFromTask(e){if(this.tasks.has(e.name)){const s=this.tasks.get(e.name)?.output;if(s){const n=typeof s=="function"?s(e):s;if(!a.isAbsolute(n))return n}}}ensurePath(e,s={}){return v.get(this.config,e)==null&&v.set(this.config,e,s),this}get(e){return v.get(this.config,e)}set(e,s){return v.set(this.config,e,s),this}addTask(e,s){const n=new S(e,s);this.tasks.set(n.id,n);const i=this.config.build.rollupOptions.input;return i[n.id]=n.input,n}addCleans(...e){return this.cleans.push(...e),this}relativePath(e){return a.relative(process.cwd(),e)}debug(){we(this.config)}}function ke(t){return t??=process.argv,t.slice(2).join(" ").split(" -- ").slice(1).join(" -- ").trim().split(" ").filter(e=>e!=="")}function Ce(t){const e=J();return e.option("cwd",{type:"string",description:"Current working directory"}),e.option("list",{alias:"l",type:"boolean",description:"List all available tasks"}),e.option("config",{alias:"c",type:"string",description:"Path to config file"}),e.option("server-file",{alias:"s",type:"string",description:"Path to server file"}),e.option("verbose",{alias:"v",type:"count",description:"Increase verbosity of output. Use multiple times for more verbosity."}),e.parseSync(t)}async function Fe(t){let e=t.path;if(process.platform==="win32"){const s=e.replace(/\\/g,"/");s.startsWith("file://")||(e=`file:///${s}`)}if(t.ts){const n=(await K.build({entryPoints:[t.path],bundle:!0,write:!1,outdir:"dist",platform:"node",format:"cjs",target:"esnext",external:["../dist","../dist/*"],packages:"external",sourcemap:"inline"})).outputFiles[0],i=Buffer.from(n.contents).toString("utf8");m.writeFileSync(n.path,i);const r=new x(n.path,void 0);return r.filename=n.path,r.paths=x._nodeModulePaths(a.dirname(n.path)),r._compile(i,n.path),C(r.exports)}else{const s=await import(e);return C(s)}}function C(t){return t={...t},t.__esModule&&delete t.__esModule,t}async function O(t,e=!1){return t=await t,!e&&Array.isArray(t)?(await Promise.all(t.map(n=>O(n,!0)))).flat():j(typeof t=="function"?await t():await t,t?.name)}async function j(t,e){if(!Array.isArray(t))return[await t];const s=await Promise.all(t),n=[];for(const i of s)Array.isArray(i)?n.push(...i):n.push(i);return n}function Te(t,e){const s=Pe(t,e);if(!s)throw new Error("No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.");return s}function Pe(t,e){let s=e?.config;return s?(a.isAbsolute(s)||(s=a.resolve(t,s)),m.existsSync(s)?{path:s,filename:s.split("/").pop()||"",type:Se(s),ts:Oe(s)}:null):Ae(t)}function Ae(t){let e=a.resolve(t,"fusionfile.js");return m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"commonjs",ts:!1}:(e=a.resolve(t,"fusionfile.mjs"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!1}:(e=a.resolve(t,"fusionfile.ts"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:(e=a.resolve(t,"fusionfile.mts"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:null)))}function Se(t){let e="unknown";return t.endsWith(".cjs")?e="commonjs":(t.endsWith(".mjs")||t.endsWith(".ts")||t.endsWith(".mts"))&&(e="module"),e}function Oe(t){return t.endsWith(".ts")||t.endsWith(".mts")}async function xe(t){const e=Object.keys(t);e.sort((i,r)=>i==="default"?-1:r==="default"?1:i.localeCompare(r));const s=[];for(const i of e){const r=t[i];s.push(await G(i,r))}const n=Q({label:w.magenta("Available Tasks"),nodes:s});console.log(n)}async function G(t,e){const s=[];e=g(await e);for(let n of e){const i=await O(n,!0);for(const r of i)typeof r=="function"?s.push(await G(r.name,r)):s.push(...await De(r))}return{label:w.cyan(t),nodes:s}}async function De(t){const e=await t.preview();return Promise.all(e.map(s=>Ne(s)))}async function Ne(t){const e=[],{input:s,output:n,extra:i}=t,r=w.yellow(s);e.push(`Input: ${r}`);const o=w.green(n);return e.push(`Output: ${o}`),e.join(" - ")}function je(t,e){t=v.uniq(t),t.length===0&&t.push("default");const s={};for(const n of t)if(e[n])s[n]=e[n];else throw new Error(`Task "${w.cyan(n)}" not found in fusion config.`);return s}async function We(t){const e={},s={};for(const n in t){const i=t[n];s[n]=await P(n,i,e)}return s}async function P(t,e,s){const n=[];if(Array.isArray(e))for(const i in e){const r=e[i];n.push(...await P(i,r,s))}else if(typeof e=="function"){if(t=e.name||t,s[t])return[];s[t]=e;const i=await O(e,!0);if(Array.isArray(i))for(const r in i){const o=i[r];n.push(...await P(r,o,s))}}else n.push(await e);return n}let f=Ce(ke(process.argv));ue(f);exports.builder=void 0;const qe=f._,z=[];function Be(t={},e){let s,n,i=!1;const r=$e(t);return typeof e=="string"||Array.isArray(e)&&e.length>0?f._=g(e):f._=qe,f=ve(f,r.cliParams),[{name:"fusion",configResolved(o){n=o,s=o.logger,o.plugins.push(...z);for(const c of o.plugins)"buildConfig"in c&&c.buildConfig?.(exports.builder)},async config(o,c){let l;o.root?l=a.resolve(o.root):l=f.cwd||process.cwd(),delete o.root,process.chdir(l),exports.builder=new N(o,c,r);let u;if(typeof r.fusionfile=="string"||!r.fusionfile){f.config??=r.fusionfile;const h=Te(l,f);u=await Fe(h)}else typeof r.fusionfile=="function"?u=C(await r.fusionfile()):u=C(r.fusionfile);if(f.list){await xe(u);return}const d=je([...f._],u),b=await We(d);for(const h in b){const L=b[h];for(const R of L)await R.config(h,exports.builder)}return exports.builder.merge(N.globalOverrideConfig),exports.builder.merge(exports.builder.overrideConfig),exports.builder.config},outputOptions(o){if(n.build.emptyOutDir){const c=n.build.outDir,l=a.resolve(c,"upload");if(m.existsSync(l))throw new Error(`The output directory: "${c}" contains an "upload" folder, please move this folder away or set an different fusion outDir.`)}},async buildStart(o){exports.builder.cleans.length>0&&await he(exports.builder.cleans,n.build.outDir||process.cwd())},configureServer(o){o.httpServer?.once("listening",()=>{const c=o.config.server.https?"https":"http",l=o.httpServer?.address(),u=l&&typeof l!="string"?l.address:"localhost",d=l&&typeof l!="string"?l.port:80,b=`${c}://${u}:${d}/`,h=a.resolve(o.config.root,r.cliParams?.serverFile??"tmp/vite-server");m.writeFileSync(a.resolve(o.config.root,h),b),i||(process.on("exit",()=>{D.existsSync(h)&&D.rmSync(h)}),process.on("SIGINT",()=>process.exit()),process.on("SIGTERM",()=>process.exit()),process.on("SIGHUP",()=>process.exit()),i=!0)})}},{name:"fusion:pre-handles",enforce:"pre",async resolveId(o,c,l){for(const u of exports.builder.resolveIdCallbacks){if(typeof u!="function")continue;const d=await u.call(this,o,c,l);if(d)return d}if(o.startsWith("hidden:"))return o},async load(o,c){for(const l of exports.builder.loadCallbacks){if(typeof l!="function")continue;const u=await l.call(this,o,c);if(u)return u}if(o.startsWith("hidden:"))return""}},{name:"fusion:post-handles",generateBundle(o,c){for(const[l,u]of Object.entries(c))u.type==="chunk"&&u.facadeModuleId?.startsWith("hidden:")&&delete c[l]},async writeBundle(o,c){const l=n.build.outDir||process.cwd();await fe(exports.builder.moveTasks,l,s),await pe(exports.builder.copyTasks,l,s),await de(exports.builder.linkTasks,l,s);for(const u of exports.builder.postBuildCallbacks)await u();for(const[u,d]of exports.builder.tasks)for(const b of d.postCallbacks)await b()}}]}function $e(t){return typeof t=="string"?{fusionfile:t}:typeof t=="function"?{fusionfile:t}:t}function _e(t){t(exports.builder)}function Me(t){if(t===null){exports.builder.overrideConfig={};return}exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,t)}function Ie(t){exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{build:{outDir:t}})}function Ee(t){exports.builder.fusionOptions.chunkDir=t}function Ge(t,e){exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{resolve:{alias:{[t]:e}}})}function ze(t,e){const s={};e&&(s[t]=e),exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{build:{rollupOptions:{external:[t],output:{globals:s}}}})}function Le(...t){z.push(...t)}function Re(...t){exports.builder.addCleans(...t),exports.builder.cleans=v.uniq(exports.builder.cleans)}exports.alias=Ge;exports.callback=le;exports.callbackAfterBuild=ae;exports.chunkDir=Ee;exports.clean=Re;exports.configureBuilder=_e;exports.copy=ne;exports.copyGlob=me;exports.css=X;exports.external=ze;exports.fileToId=E;exports.isDev=ce;exports.isProd=$;exports.isWindows=F;exports.js=Z;exports.link=re;exports.mergeViteConfig=Me;exports.move=te;exports.moveGlob=ge;exports.outDir=Ie;exports.plugin=Le;exports.shortHash=_;exports.symlink=M;exports.useFusion=Be;
//# sourceMappingURL=index.cjs.map
