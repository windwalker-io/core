"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const c=require("chalk"),m=require("vite"),y=require("node:fs"),f=require("node:path"),x=require("archy"),v=require("lodash-es"),C=require("yargs"),L=require("yargs/helpers"),I=require("node:url"),$=require("autoprefixer");var w=typeof document<"u"?document.currentScript:null,p=(e=>(e.NONE="none",e.SAME_FILE="same_file",e.SEPARATE_FILE="separate_file",e))(p||{});function _(e){return Array.isArray(e)?e:[e]}function q(e,t){return Array.isArray(e)?e.map(t):t(e)}function F(e,t={}){return e=q(e,s=>(typeof s=="string"&&(s.endsWith("/")?s={dir:s,...t}:s={dir:f.dirname(s),entryFileNames:f.normalize(s).replace(/\\/g,"/").split("/").pop(),...t}),s)),_(e)}function u(e,...t){if(e??={},!t.length)return e;for(const s of t)s&&(typeof s=="function"?e=s(e)??e:e={...e,...s});return e}function j(e){if(e=v.cloneDeep(e),e.file){const t=e.file.split("."),s=t.pop();e.file=`${t.join(".")}.min.${s}`}else if(e.dir&&typeof e.entryFileNames=="string"){const t=e.entryFileNames.split("."),s=t.pop();e.entryFileNames=`${t.join(".")}.min.${s}`}return e}function T(e,t){return u({entry:e},t)}function g(e,t,s){return u({build:{lib:e,rollupOptions:{output:t},emptyOutDir:!1,target:"esnext"}},s)}async function P(e,t,s={}){s.verbose??=S;let n=F(t,{format:"es"});const r=[];for(const o of n){const i=E(e,n,s,l=>(l.build.minify=s.minify===p.SAME_FILE?"esbuild":!1,l.build.cssMinify=s.minify===p.SAME_FILE?"esbuild":!1,l));if(r.push(u(i,s?.vite)),s?.minify===p.SEPARATE_FILE){const l=j(o),a=E(e,l,s,d=>(d.build.minify="esbuild",d.build.cssMinify="esbuild",d));r.push(u(a,s?.vite))}}return r}function E(e,t,s,n){t=v.cloneDeep(t);const r=g(void 0,t,o=>{o.build.rollupOptions.input=e,o.build.emptyOutDir=s.clean??!1;for(const i of _(o.build.rollupOptions.output))i.assetFileNames=String(i.entryFileNames),delete i.entryFileNames;return o.build.cssCodeSplit=!0,o.css={transformer:"postcss",postcss:u({plugins:[$({overrideBrowserslist:s.browserslist})]},s.postcss)},o});return u(r,n,s.vite)}async function R(e,t,s={}){const n=u({target:s?.target||"esnext"},s?.esbuild);return D(t,s,(r,o)=>o?g(T(e),r,i=>(i.build.minify="esbuild",i.build.emptyOutDir=s.clean||!1,i.build.target=s.target||"esnext",i.esbuild=n,i)):g(T(e),r,i=>(i.build.minify=s?.minify===p.SAME_FILE?"esbuild":!1,i.build.emptyOutDir=s.clean||!1,i.build.target=s.target||"esnext",i.esbuild=n,i)))}function D(e,t,s){t.verbose??=S;const n=F(e,{format:t?.format||"es"});for(const i of n)i.format==="umd"&&(i.name=t?.umdName);const r=[],o=s(n,!1);if(r.push(u(o,t.vite)),t?.minify===p.SEPARATE_FILE){const i=n.map(a=>j(a)),l=s(i,!0);r.push(u(l,t?.vite))}return r}const W=Object.freeze(Object.defineProperty({__proto__:null,MinifyOptions:p,css:P,js:R},Symbol.toStringTag,{value:"Module"}));async function M(e,t){const s=[];for(const n in e){const r=[],o=e[n];console.log(`▶️ - ${c.cyan(n)} Start...`);for(const l of o){const a=m.build(m.defineConfig(l));t.series&&await a,r.push(a)}const i=Promise.all(r).then(()=>{console.log(`✅ - ${c.cyan(n)} completed.`)});t.series&&await i,s.push(i)}await Promise.all(s)}async function k(e,t){const s=[];for(const r in e){const o=e[r];console.log(`▶️ - ${c.cyan(r)} Start...`);for(const i of o){const l=m.build(m.mergeConfig(m.defineConfig(i),{build:{watch:{}}}));l.then(a=>{a.on("event",d=>{switch(d.code){case"START":console.log("→ Start Watching...");break;case"BUNDLE_START":console.log("→ Start Bundling...");break;case"BUNDLE_END":console.log(`✔ Bundled, uses ${d.duration}ms`),d.result?.close();break;case"END":console.log("Watching...");break;case"ERROR":console.error("✖ ERROR: ",d.error);break}})}),s.push(l)}}const n=await Promise.all(s);process.on("SIGINT",async()=>{for(const r of n)await r.close();console.log(`
🛑 STOP Watching...`),process.exit(0)})}async function U(e){let t=e.path;if(process.platform==="win32"){const n=t.replace(/\\/g,"/");n.startsWith("file://")||(t=`file:///${n}`)}return{...await import(t)}}async function b(e,t=!1){return!t&&Array.isArray(e)?(await Promise.all(e.map(n=>b(n,!0)))).flat():O(typeof e=="function"?await e():await e,e?.name)}async function O(e,t){if(!Array.isArray(e))return[await e];const s=await Promise.all(e),n=[];for(const r of s)Array.isArray(r)?n.push(...r):n.push(r);return n}function B(e,t){const s=V(e,t);if(!s)throw new Error("No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.");return s}function V(e,t){let s=t?.config;return s?(f.isAbsolute(s)||(s=f.resolve(e,s)),y.existsSync(s)?{path:s,filename:s.split("/").pop()||"",type:G(s),ts:J(s)}:null):z(e)}function z(e){let t=f.resolve(e,"fusionfile.js");return y.existsSync(t)?{path:t,filename:t.split("/").pop()||"",type:"commonjs",ts:!1}:(t=f.resolve(e,"fusionfile.mjs"),y.existsSync(t)?{path:t,filename:t.split("/").pop()||"",type:"module",ts:!1}:(t=f.resolve(e,"fusionfile.ts"),y.existsSync(t)?{path:t,filename:t.split("/").pop()||"",type:"module",ts:!0}:(t=f.resolve(e,"fusionfile.mts"),y.existsSync(t)?{path:t,filename:t.split("/").pop()||"",type:"module",ts:!0}:null)))}function G(e){let t="unknown";return e.endsWith(".cjs")?t="commonjs":(e.endsWith(".mjs")||e.endsWith(".ts")||e.endsWith(".mts"))&&(t="module"),t}function J(e){return e.endsWith(".ts")||e.endsWith(".mts")}async function H(e){const t=Object.keys(e);t.sort((r,o)=>r==="default"?-1:o==="default"?1:r.localeCompare(o));const s=[];for(const r of t){const o=e[r],i=await b(o,!0);s.push(await N(r,i))}const n=x({label:c.magenta("Available Tasks"),nodes:s});console.log(n)}async function N(e,t){const s=[];Array.isArray(t)||(t=[t]);for(const n of t)if(typeof n=="function"){let r=await b(n,!0);s.push(await N(n.name,r))}else s.push(K(n));return{label:c.cyan(e),nodes:s}}function K(e,t=4){const s=[],n=e.build?.lib;if(n&&n.entry){const o=n.entry;let i="";typeof o=="string"?i=c.yellow(o):Array.isArray(o)?i=c.yellow(o.join(", ")):typeof o=="object"&&(i=c.yellow(Object.values(o).join(", "))),s.push(`Input: ${i}`)}const r=e.build?.rollupOptions?.output;return r&&(Array.isArray(r)?r:[r]).forEach((i,l)=>{let a="";i.file?a=c.green(i.file):i.dir&&(a=c.green(i.dir)),s.push(`Output[${l}]: ${a}`)}),s.join(" - ")}function Q(e,t){e=v.uniq(e),e.length===0&&e.push("default");const s={};for(const n of e)if(t[n])s[n]=t[n];else throw new Error(`Task "${c.cyan(n)}" not found in fusion config.`);return s}async function X(e){const t={},s={};for(const n in e){const r=e[n];s[n]=await A(n,r,t)}return s}async function A(e,t,s){const n=[];if(Array.isArray(t))for(const r in t){const o=t[r];n.push(...await A(r,o,s))}else if(typeof t=="function"){if(e=t.name||e,s[e])return[];s[e]=t;const r=await b(t,!0);if(Array.isArray(r))for(const o in r){const i=r[o];n.push(...await A(o,i,s))}}else n.push(await t);return n}function Y(){const e=C();return e.option("watch",{alias:"w",type:"boolean",description:"Watch files for changes and re-run the tasks"}),e.option("cwd",{type:"string",description:"Current working directory"}),e.option("list",{alias:"l",type:"boolean",description:"List all available tasks"}),e.option("config",{alias:"c",type:"string",description:"Path to config file"}),e.option("series",{alias:"s",type:"boolean",description:"Run tasks in series instead of parallel"}),e.option("verbose",{alias:"v",type:"count",description:"Increase verbosity of output. Use multiple times for more verbosity."}),e.parseSync(L.hideBin(process.argv))}async function Z(e){try{await ee(e)}catch(t){if(t instanceof Error){if(e.verbose&&e.verbose>0)throw t;console.error(t),process.exit(1)}else throw t}}async function ee(e){let t=e?.cwd,s;t?(s=t=f.resolve(t),process.chdir(t)):s=process.cwd();const n=B(s,e),r=await U(n);if(e.list){await H(r);return}const o=Q([...e._],r),i=await X(o);e.watch?await k(i):await M(i,e)}let h;const te=process.argv[1]&&I.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:w&&w.tagName.toUpperCase()==="SCRIPT"&&w.src||new URL("index.cjs",document.baseURI).href)===process.argv[1],se={...W,params:h};te&&(h=Y(),Z(h));const S=h?.verbose?h?.verbose>0:!1;exports.MinifyOptions=p;exports.css=P;exports.default=se;exports.isVerbose=S;exports.js=R;
//# sourceMappingURL=index.cjs.map
