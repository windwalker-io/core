"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const a=require("chalk"),w=require("vite"),d=require("node:fs"),c=require("node:path"),P=require("archy"),b=require("lodash-es"),q=require("yargs"),M=require("yargs/helpers"),N=require("node:url"),L=require("path"),x=require("rimraf"),I=require("rollup-plugin-esbuild");var g=typeof document<"u"?document.currentScript:null,u=(e=>(e.NONE="none",e.SAME_FILE="same_file",e.SEPARATE_FILE="separate_file",e))(u||{});function E(e){return Array.isArray(e)?e:[e]}function $(e,n){return Array.isArray(e)?e.map(n):n(e)}function T(e,n={}){return e=$(e,t=>(typeof t=="string"&&(t.endsWith("/")?t={dir:t,...n}:t={dir:c.dirname(t),entryFileNames:c.normalize(t).replace(/\\/g,"/").split("/").pop(),...n}),t)),E(e)}function p(e,...n){if(e??={},!n.length)return e;for(const t of n)t&&(typeof t=="function"?e=t(e)??e:e={...e,...t});return e}function j(e){if(e=b.cloneDeep(e),e.file){const n=e.file.split("."),t=n.pop();e.file=`${n.join(".")}.min.${t}`}else if(e.dir&&typeof e.entryFileNames=="string"){const n=e.entryFileNames.split("."),t=n.pop();e.entryFileNames=`${n.join(".")}.min.${t}`}return e}function R(e,n,t){return p({build:{lib:e,rollupOptions:{output:n},emptyOutDir:!1}},t)}async function F(e,n,t={}){t.verbose??=A;let r=T(n,{format:"es"});const s=[];for(const i of r){const o=S(e,r,t,l=>(l.build.minify=t.minify===u.SAME_FILE?"esbuild":!1,l.build.cssMinify=t.minify===u.SAME_FILE?"esbuild":!1,l));if(s.push(p(o,t?.vite)),t?.minify===u.SEPARATE_FILE){const l=j(i),f=S(e,l,t,y=>(y.build.minify="esbuild",y.build.cssMinify="esbuild",y));s.push(p(f,t?.vite))}}return s}function S(e,n,t,r){n=b.cloneDeep(n);const s=R(void 0,n,i=>{i.build.rollupOptions.input=e;for(const o of E(i.build.rollupOptions.output))o.assetFileNames=String(o.entryFileNames),delete o.entryFileNames;return i.build.cssCodeSplit=!0,i.css={modules:{scopeBehaviour:"global"},transformer:"postcss"},i.plugins=[{name:"drop-vite-facade-css",generateBundle(o,l){for(const[f,y]of Object.entries(l))y.type==="asset"&&f==="__plaecholder__.min.css"&&delete l[f]}}],i});return p(s,r,t.vite)}function W(e,n){const t=new Set;return{name:"clean-output",outputOptions(r){if(e===!1)return r;const s=r.dir?r.dir:r.file?L.dirname(r.file):null;s&&t.add(s)},async generateBundle(r){if(e===!1)return;const s=t.values().map(async i=>{if(n&&console.log(`Clean: ${a.yellow(i)}`),typeof e=="function")return e(i,r);if(i)return x.rimraf(i)});await Promise.all(s)}}}async function O(e,n,t={}){function r(s){return[W(t.clean||!1,t.verbose),I(p({target:t?.target||"esnext",tsconfig:t?.tsconfig??"./tsconfig.json"},s))]}return D(n,t,(s,i)=>i?{input:e,output:s,plugins:r({minify:!0,sourceMap:!0})}:{input:e,output:s,plugins:r({minify:t?.minify===u.SAME_FILE,sourceMap:t?.minify===u.SAME_FILE})})}function D(e,n,t){n.verbose??=A;const r=T(e,{format:n?.format||"es"});for(const o of r)o.format==="umd"&&(o.name=n?.umdName);const s=[],i=t(r,!1);if(s.push(p(i,n.vite)),n?.minify===u.SEPARATE_FILE){const o=r.map(f=>j(f)),l=t(o,!0);s.push(p(l,n?.vite))}return s}const U=Object.freeze(Object.defineProperty({__proto__:null,MinifyOptions:u,css:F,js:O},Symbol.toStringTag,{value:"Module"}));async function k(e){for(const n in e){const t=e[n];console.log(`▶️ - ${a.cyan(n)} Start...`);for(const r of t)await w.build(w.defineConfig(r));console.log(`✅ - ${a.cyan(n)} completed.`)}}async function B(e){let n=e.path;if(process.platform==="win32"){const r=n.replace(/\\/g,"/");r.startsWith("file://")||(n=`file:///${r}`)}return{...await import(n)}}async function h(e,n=!1){return!n&&Array.isArray(e)?(await Promise.all(e.map(r=>h(r,!0)))).flat():_(typeof e=="function"?await e():await e,e?.name)}async function _(e,n){if(!Array.isArray(e))return[await e];const t=await Promise.all(e),r=[];for(const s of t)Array.isArray(s)?r.push(...s):r.push(s);return r}function z(e,n){const t=V(e,n);if(!t)throw new Error("No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.");return t}function V(e,n){let t=n?.config;return t?(c.isAbsolute(t)||(t=c.resolve(e,t)),d.existsSync(t)?{path:t,filename:t.split("/").pop()||"",type:J(t),ts:H(t)}:null):G(e)}function G(e){let n=c.resolve(e,"fusionfile.js");return d.existsSync(n)?{path:n,filename:n.split("/").pop()||"",type:"commonjs",ts:!1}:(n=c.resolve(e,"fusionfile.mjs"),d.existsSync(n)?{path:n,filename:n.split("/").pop()||"",type:"module",ts:!1}:(n=c.resolve(e,"fusionfile.ts"),d.existsSync(n)?{path:n,filename:n.split("/").pop()||"",type:"module",ts:!0}:(n=c.resolve(e,"fusionfile.mts"),d.existsSync(n)?{path:n,filename:n.split("/").pop()||"",type:"module",ts:!0}:null)))}function J(e){let n="unknown";return e.endsWith(".cjs")?n="commonjs":(e.endsWith(".mjs")||e.endsWith(".ts")||e.endsWith(".mts"))&&(n="module"),n}function H(e){return e.endsWith(".ts")||e.endsWith(".mts")}async function K(e){const n=Object.keys(e);n.sort((s,i)=>s==="default"?-1:i==="default"?1:s.localeCompare(i));const t=[];for(const s of n){const i=e[s],o=await h(i,!0);t.push(await C(s,o))}const r=P({label:a.magenta("Available Tasks"),nodes:t});console.log(r)}async function C(e,n){const t=[];Array.isArray(n)||(n=[n]);for(const r of n)if(typeof r=="function"){let s=await h(r,!0);t.push(await C(r.name,s))}else t.push(Q(r));return{label:a.cyan(e),nodes:t}}function Q(e,n=4){const t=[],r=e.build?.lib;if(r&&r.entry){const i=r.entry;let o="";typeof i=="string"?o=a.yellow(i):Array.isArray(i)?o=a.yellow(i.join(", ")):typeof i=="object"&&(o=a.yellow(Object.values(i).join(", "))),t.push(`Input: ${o}`)}const s=e.build?.rollupOptions?.output;return s&&(Array.isArray(s)?s:[s]).forEach((o,l)=>{let f="";o.file?f=a.green(o.file):o.dir&&(f=a.green(o.dir)),t.push(`Output[${l}]: ${f}`)}),t.join(" - ")}function X(e,n){e=b.uniq(e),e.length===0&&e.push("default");const t={};for(const r of e)if(n[r])t[r]=n[r];else throw new Error(`Task "${a.cyan(r)}" not found in fusion config.`);return t}async function Y(e){const n={},t={};for(const r in e){const s=e[r];t[r]=await v(r,s,n)}return t}async function v(e,n,t){const r=[];if(Array.isArray(n))for(const s in n){const i=n[s];r.push(...await v(s,i,t))}else if(typeof n=="function"){if(e=n.name||e,t[e])return[];t[e]=n;const s=await h(n,!0);if(Array.isArray(s))for(const i in s){const o=s[i];r.push(...await v(i,o,t))}}else r.push(await n);return r}function Z(){const e=q();return e.option("watch",{alias:"w",type:"boolean",description:"Watch files for changes and re-run the tasks"}),e.option("cwd",{type:"string",description:"Current working directory"}),e.option("list",{alias:"l",type:"boolean",description:"List all available tasks"}),e.option("config",{alias:"c",type:"string",description:"Path to config file"}),e.option("verbose",{alias:"v",type:"count",description:"Increase verbosity of output. Use multiple times for more verbosity."}),e.parseSync(M.hideBin(process.argv))}async function ee(e){try{await ne(e)}catch(n){if(n instanceof Error){if(e.verbose&&e.verbose>0)throw n;console.error(n),process.exit(1)}else throw n}}async function ne(e){let n=e?.cwd,t;n?(t=n=c.resolve(n),process.chdir(n)):t=process.cwd();const r=z(t,e),s=await B(r);if(e.list){await K(s);return}const i=X([...e._],s),o=await Y(i);await k(o)}let m;const te=process.argv[1]&&N.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:g&&g.tagName.toUpperCase()==="SCRIPT"&&g.src||new URL("index.cjs",document.baseURI).href)===process.argv[1],re={...U,params:m};te&&(m=Z(),ee(m));const A=m?.verbose?m?.verbose>0:!1;exports.MinifyOptions=u;exports.css=F;exports.default=re;exports.isVerbose=A;exports.js=O;
//# sourceMappingURL=index.cjs.map
