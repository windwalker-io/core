"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const pe=require("crypto"),G=require("fast-glob"),d=require("fs-extra"),de=require("node:crypto"),l=require("node:path"),he=require("node:util"),y=require("vite"),g=require("lodash-es"),me=require("yargs"),ge=require("esbuild"),$=require("module"),h=require("node:fs"),ye=require("archy"),b=require("chalk"),B=require("fs"),be=require("micromatch");function m(t){return Array.isArray(t)?t:[t]}function O(t,e){return Array.isArray(t)?t.map(e):e(t)}function E(t,e){return t=m(t),t.map(e)}function R(t,e,s={}){return new ve(t,e,s)}class ve{constructor(e,s,n={}){this.input=e,this.output=s,this.options=n}config(e,s){return E(this.input,n=>{const i=s.addTask(n,e);return s.assetFileNamesCallbacks.push(o=>{const r=o.names[0];if(r&&l.basename(r,".css")===i.id)return this.output?i.normalizeOutput(this.output,".css"):l.parse(n).name+".css"}),i})}preview(){return m(this.input).map(e=>({input:e,output:this.output||l.basename(e),extra:{}}))}}function z(t,e){return new we(t,e)}class we{constructor(e,s){this.input=e,this.output=s}config(e,s){return E(this.input,n=>{const i=s.addTask(n,e);return s.entryFileNamesCallbacks.push(o=>{const r=o.name;if(r&&r===i.id)return this.output?i.normalizeOutput(this.output):l.parse(n).name+".js"}),i})}preview(){return m(this.input).map(e=>({input:e,output:this.output||l.basename(e),extra:{}}))}}function V(t,e){return new ke(t,e)}class ke{constructor(e,s){this.input=e,this.dest=s}config(e,s){O(this.input,n=>{s.moveTasks.push({src:n,dest:this.dest,options:{}})})}preview(){return m(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function L(t,e){return new Ce(t,e)}class Ce{constructor(e,s){this.input=e,this.dest=s}config(e,s){O(this.input,n=>{s.copyTasks.push({src:n,dest:this.dest,options:{}})})}preview(){return m(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function H(t,e,s={}){return new Fe(t,e,s)}class Fe{constructor(e,s,n={}){this.input=e,this.dest=s,this.options=n}config(e,s){O(this.input,n=>{s.linkTasks.push({src:n,dest:this.dest,options:this.options})})}preview(){return m(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function U(t){return new K(t)}function J(t){return new K(t,!0)}class K{constructor(e,s=!1){this.handler=e,this.afterBuild=s}config(e,s){this.afterBuild?s.postBuildCallbacks.push(()=>this.handler(e,s)):this.handler(e,s)}preview(){return[]}}exports.params=void 0;function Pe(t){return exports.params=t,exports.isVerbose=exports.params?.verbose?exports.params?.verbose>0:!1,t}exports.isVerbose=!1;const x=process.env.NODE_ENV==="production",Q=!x;function F(){return process.platform==="win32"}function D(t,e=8){let s=pe.createHash("sha1").update(t).digest("hex");return e&&e>0&&(s=s.substring(0,e)),s}function C(t,e,s){const n=[];t=A(t,s.outDir),e=A(e,s.outDir);const i=N(t),o=Z(t)?G.globSync(t.replace(/\\/g,"/"),s.globOptions):[t];for(let r of o){let c,a=e;xe(e)?(c=a,a=a+l.relative(i,r)):c=l.dirname(a),d.ensureDirSync(c),n.push(s.handler(r,a))}return n}function Te(t,e,s){const n=[];for(const{src:i,dest:o,options:r}of t){const c=C(i,o,{outDir:e,handler:async(a,u)=>(s.info(`Moving file from ${l.relative(e,a)} to ${l.relative(e,u)}`),d.move(a,u,{overwrite:!0})),globOptions:{onlyFiles:!0}});n.push(...c)}return Promise.all(n)}function Ae(t,e,s){const n=[];for(const{src:i,dest:o,options:r}of t){const c=C(i,o,{outDir:e,handler:async(a,u)=>(s.info(`Copy file from ${l.relative(e,a)} to ${l.relative(e,u)}`),d.copy(a,u,{overwrite:!0})),globOptions:{onlyFiles:!0}});n.push(...c)}return Promise.all(n)}function Se(t,e,s){const n=[];for(const{src:i,dest:o,options:r}of t){const c=C(i,o,{outDir:e,handler:async(a,u)=>(s.info(`Link file from ${l.relative(e,a)} to ${l.relative(e,u)}`),j(a,u,r?.force??!1)),globOptions:{onlyFiles:!1}});n.push(...c)}return Promise.all(n)}function Oe(t,e){const s=[];e=e.replace(/\\/g,"/");for(let n of t){n=A(n,e),n=l.resolve(n);const i=Z(n)?G.globSync(n.replace(/\\/g,"/"),{onlyFiles:!1}):[n],o=l.resolve(e+"/upload").replace(/\\/g,"/");for(let r of i){if(r.replace(/\\/g,"/").startsWith(o))throw new Error("Refuse to delete `upload/*` folder.");s.push(d.remove(r))}}return Promise.all(s)}async function X(t,e){const s=C(t,e,{outDir:process.cwd(),handler:async(n,i)=>d.copy(n,i,{overwrite:!0}),globOptions:{onlyFiles:!0}});await Promise.all(s)}async function Y(t,e){const s=C(t,e,{outDir:process.cwd(),handler:async(n,i)=>d.move(n,i,{overwrite:!0}),globOptions:{onlyFiles:!0}});await Promise.all(s)}async function j(t,e,s=!1){return t=l.resolve(t),e=l.resolve(e),F()&&!d.lstatSync(t).isFile()?d.ensureSymlink(t,e,"junction"):F()&&d.lstatSync(t).isFile()&&s?d.ensureLink(t,e):d.ensureSymlink(t,e)}function xe(t){return t.endsWith("/")||t.endsWith("\\")}function N(t){const e=["*","?","[","]"],s=[...t].findIndex(n=>e.includes(n));return s===-1?l.dirname(t):l.dirname(t.slice(0,s+1))}function Z(t){return["*","?","[","]"].some(s=>t.includes(s))}function A(t,e){return t.startsWith(".")?t=l.resolve(t):l.isAbsolute(t)||(t=e+"/"+t),t}function W(t,e){return t=l.normalize(t),e||=de.randomBytes(4).toString("hex"),e+"-"+D(t)}const De=Object.freeze(Object.defineProperty({__proto__:null,callback:U,callbackAfterBuild:J,copy:L,copyGlob:X,css:R,fileToId:W,getGlobBaseFromPattern:N,isDev:Q,isProd:x,get isVerbose(){return exports.isVerbose},isWindows:F,js:z,link:H,move:V,moveGlob:Y,get params(){return exports.params},shortHash:D,symlink:j},Symbol.toStringTag,{value:"Module"}));class _{constructor(e,s){this.input=e,this.group=s,this.id=_.toFileId(e,s),this.input=l.normalize(e)}id;output;postCallbacks=[];dest(e){return typeof e=="string"&&(e=this.normalizeOutput(e)),this.output=e,this}addPostCallback(e){return this.postCallbacks.push(e),this}normalizeOutput(e,s=".js"){return(e.endsWith("/")||e.endsWith("\\"))&&(e+=l.parse(this.input).name+s),e}static toFileId(e,s){return W(e,s)}}function je(t,...e){if(!e.length)return t;for(const s of e)s&&(typeof s=="function"?t=s(t)??t:t=y.mergeConfig(t,s));return t}function Ne(t,e=10){console.log(he.inspect(t,{depth:e,colors:!0}))}class M{constructor(e,s,n){this.config=e,this.env=s,this.fusionOptions=n,this.config=y.mergeConfig(this.config,{build:{manifest:"manifest.json",rollupOptions:{preserveEntrySignatures:"strict",input:{},output:this.getDefaultOutput()},emptyOutDir:!1,sourcemap:s.mode!=="production"?"inline":!1},plugins:[],css:{devSourcemap:!0},esbuild:{target:"es2022"}}),this.addTask("hidden:placeholder")}static globalOverrideConfig={};overrideConfig={};entryFileNamesCallbacks=[];chunkFileNamesCallbacks=[];assetFileNamesCallbacks=[];moveTasks=[];copyTasks=[];linkTasks=[];postBuildCallbacks=[];resolveIdCallbacks=[];loadCallbacks=[];watches=[];cleans=[];tasks=new Map;merge(e){return typeof e=="function"?(this.config=e(this.config)??this.config,this):(this.config=y.mergeConfig(this.config,e),this)}getDefaultOutput(){return{entryFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const n of this.entryFileNamesCallbacks){const i=n(e);if(i)return i}return"[name].js"},chunkFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const i of this.chunkFileNamesCallbacks){const o=i(e);if(o)return o}return`${this.getChunkDir()}[name]-[hash].js`},assetFileNames:e=>{for(const s of this.assetFileNamesCallbacks){const n=s(e);if(n)return n}return"[name].[ext]"}}}getChunkDir(){let e=this.fusionOptions.chunkDir??"chunks";return e.replace(/\\/g,"/"),e&&!e.endsWith("/")&&(e+="/"),(e==="./"||e==="/")&&(e=""),e}getChunkNameFromTask(e){if(this.tasks.has(e.name)){const s=this.tasks.get(e.name)?.output;if(s){const n=typeof s=="function"?s(e):s;if(!l.isAbsolute(n))return n}}}ensurePath(e,s={}){return g.get(this.config,e)==null&&g.set(this.config,e,s),this}get(e){return g.get(this.config,e)}set(e,s){return g.set(this.config,e,s),this}addTask(e,s){const n=new _(e,s);this.tasks.set(n.id,n);const i=this.config.build.rollupOptions.input;return i[n.id]=n.input,n}addCleans(...e){return this.cleans.push(...e),this}relativePath(e){return l.relative(process.cwd(),e)}debug(){Ne(this.config)}}function We(t){return t??=process.argv,t.slice(2).join(" ").split(" -- ").slice(1).join(" -- ").trim().split(" ").filter(e=>e!=="")}function _e(t){const e=me();return e.option("cwd",{type:"string",description:"Current working directory"}),e.option("list",{alias:"l",type:"boolean",description:"List all available tasks"}),e.option("config",{alias:"c",type:"string",description:"Path to config file"}),e.option("server-file",{alias:"s",type:"string",description:"Path to server file"}),e.option("verbose",{alias:"v",type:"count",description:"Increase verbosity of output. Use multiple times for more verbosity."}),e.parseSync(t)}async function qe(t){let e=t.path;if(process.platform==="win32"){const s=e.replace(/\\/g,"/");s.startsWith("file://")||(e=`file:///${s}`)}if(t.ts){const n=(await ge.build({entryPoints:[t.path],bundle:!0,write:!1,outdir:"dist",platform:"node",format:"cjs",target:"esnext",external:["../dist","../dist/*"],packages:"external",sourcemap:"inline"})).outputFiles[0],i=Buffer.from(n.contents).toString("utf8");h.writeFileSync(n.path,i);const o=new $(n.path,void 0);return o.filename=n.path,o.paths=$._nodeModulePaths(l.dirname(n.path)),o._compile(i,n.path),P(o.exports)}else{const s=await import(e);return P(s)}}function P(t){return t={...t},t.__esModule&&delete t.__esModule,t}async function q(t,e=!1){return t=await t,!e&&Array.isArray(t)?(await Promise.all(t.map(n=>q(n,!0)))).flat():I(typeof t=="function"?await t():await t,t?.name)}async function I(t,e){if(!Array.isArray(t))return[await t];const s=await Promise.all(t),n=[];for(const i of s)Array.isArray(i)?n.push(...i):n.push(i);return n}function $e(t,e){const s=Be(t,e);if(!s)throw new Error("No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.");return s}function Be(t,e){let s=e?.config;return s?(l.isAbsolute(s)||(s=l.resolve(t,s)),h.existsSync(s)?{path:s,filename:s.split("/").pop()||"",type:Ie(s),ts:Ge(s)}:null):Me(t)}function Me(t){let e=l.resolve(t,"fusionfile.js");return h.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"commonjs",ts:!1}:(e=l.resolve(t,"fusionfile.mjs"),h.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!1}:(e=l.resolve(t,"fusionfile.ts"),h.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:(e=l.resolve(t,"fusionfile.mts"),h.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:null)))}function Ie(t){let e="unknown";return t.endsWith(".cjs")?e="commonjs":(t.endsWith(".mjs")||t.endsWith(".ts")||t.endsWith(".mts"))&&(e="module"),e}function Ge(t){return t.endsWith(".ts")||t.endsWith(".mts")}async function Ee(t){const e=Object.keys(t);e.sort((i,o)=>i==="default"?-1:o==="default"?1:i.localeCompare(o));const s=[];for(const i of e){const o=t[i];s.push(await ee(i,o))}const n=ye({label:b.magenta("Available Tasks"),nodes:s});console.log(n)}async function ee(t,e){const s=[];e=m(await e);for(let n of e){const i=await q(n,!0);for(const o of i)typeof o=="function"?s.push(await ee(o.name,o)):s.push(...await Re(o))}return{label:b.cyan(t),nodes:s}}async function Re(t){const e=await t.preview();return Promise.all(e.map(s=>ze(s)))}async function ze(t){const e=[],{input:s,output:n,extra:i}=t,o=b.yellow(s);e.push(`Input: ${o}`);const r=b.green(n);return e.push(`Output: ${r}`),e.join(" - ")}function Ve(t,e){t=g.uniq(t),t.length===0&&t.push("default");const s={};for(const n of t)if(e[n])s[n]=e[n];else throw new Error(`Task "${b.cyan(n)}" not found in fusion config.`);return s}async function Le(t){const e={},s={};for(const n in t){const i=t[n];s[n]=await S(n,i,e)}return s}async function S(t,e,s){const n=[];if(Array.isArray(e))for(const i in e){const o=e[i];n.push(...await S(i,o,s))}else if(typeof e=="function"){if(t=e.name||t,s[t])return[];s[t]=e;const i=await q(e,!0);if(Array.isArray(i))for(const o in i){const r=i[o];n.push(...await S(o,r,s))}}else n.push(await e);return n}let p=_e(We(process.argv));Pe(p);exports.builder=void 0;const He=p._,te=[];function se(t={},e){let s,n,i=!1;const o=Ue(t);return typeof e=="string"||Array.isArray(e)&&e.length>0?p._=m(e):p._=He,p=je(p,o.cliParams),[{name:"fusion",configResolved(r){n=r,s=r.logger,r.plugins.push(...te);for(const c of r.plugins)"buildConfig"in c&&c.buildConfig?.(exports.builder)},async config(r,c){let a;r.root?a=l.resolve(r.root):a=p.cwd||process.cwd(),delete r.root,process.chdir(a),exports.builder=new M(r,c,o);let u;if(typeof o.fusionfile=="string"||!o.fusionfile){p.config??=o.fusionfile;const w=$e(a,p);u=await qe(w)}else typeof o.fusionfile=="function"?u=P(await o.fusionfile()):u=P(o.fusionfile);if(p.list){await Ee(u);return}const f=Ve([...p._],u),v=await Le(f);for(const w in v){const T=v[w];for(const k of T)await k.config(w,exports.builder)}return exports.builder.merge(M.globalOverrideConfig),exports.builder.merge(exports.builder.overrideConfig),exports.builder.config},outputOptions(r){if(n.build.emptyOutDir){const c=n.build.outDir,a=l.resolve(c,"upload");if(h.existsSync(a))throw new Error(`The output directory: "${c}" contains an "upload" folder, please move this folder away or set an different fusion outDir.`)}},async buildStart(r){exports.builder.cleans.length>0&&await Oe(exports.builder.cleans,n.build.outDir||process.cwd())},configureServer(r){r.httpServer?.once("listening",()=>{const u=r.config.server.https?"https":"http",f=r.httpServer?.address(),v=f&&typeof f!="string"?f.address:"localhost",w=f&&typeof f!="string"?f.port:80,T=`${u}://${v}:${w}/`,k=l.resolve(r.config.root,o.cliParams?.serverFile??"tmp/vite-server");h.writeFileSync(l.resolve(r.config.root,k),T),i||(process.on("exit",()=>{B.existsSync(k)&&B.rmSync(k)}),process.on("SIGINT",()=>process.exit()),process.on("SIGTERM",()=>process.exit()),process.on("SIGHUP",()=>process.exit()),i=!0)});const c=exports.builder.watches.map(u=>l.resolve(u).replace(/\\/g,"/"));r.watcher.add(c);const a=u=>{be.isMatch(u,c)&&(r.ws.send({type:"full-reload",path:"*"}),s.info(`${b.green("full reload")} ${b.dim(l.relative(process.cwd(),u))}`,{timestamp:!0}))};r.watcher.on("add",a),r.watcher.on("change",a)}},{name:"fusion:pre-handles",enforce:"pre",async resolveId(r,c,a){for(const u of exports.builder.resolveIdCallbacks){if(typeof u!="function")continue;const f=await u.call(this,r,c,a);if(f)return f}if(r.startsWith("hidden:"))return r},async load(r,c){for(const a of exports.builder.loadCallbacks){if(typeof a!="function")continue;const u=await a.call(this,r,c);if(u)return u}if(r.startsWith("hidden:"))return""}},{name:"fusion:post-handles",generateBundle(r,c){for(const[a,u]of Object.entries(c))u.type==="chunk"&&u.facadeModuleId?.startsWith("hidden:")&&delete c[a]},async writeBundle(r,c){const a=n.build.outDir||process.cwd();await Te(exports.builder.moveTasks,a,s),await Ae(exports.builder.copyTasks,a,s),await Se(exports.builder.linkTasks,a,s);for(const u of exports.builder.postBuildCallbacks)await u(r,c);for(const[u,f]of exports.builder.tasks)for(const v of f.postCallbacks)await v(r,c)}}]}function Ue(t){return typeof t=="string"?{fusionfile:t}:typeof t=="function"?{fusionfile:t}:t}function ne(t){t(exports.builder)}function ie(t){if(t===null){exports.builder.overrideConfig={};return}exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,t)}function re(t){exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{build:{outDir:t}})}function oe(t){exports.builder.fusionOptions.chunkDir=t}function le(t,e){exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{resolve:{alias:{[t]:e}}})}function ae(t,e){const s={};e&&(s[t]=e),exports.builder.overrideConfig=y.mergeConfig(exports.builder.overrideConfig,{build:{rollupOptions:{external:[t],output:{globals:s}}}})}function ue(...t){te.push(...t)}function ce(...t){exports.builder.addCleans(...t),exports.builder.cleans=g.uniq(exports.builder.cleans)}function fe(...t){exports.builder.watches.push(...t),exports.builder.watches=g.uniq(exports.builder.watches)}const Je={...De,useFusion:se,configureBuilder:ne,mergeViteConfig:ie,outDir:re,chunkDir:oe,alias:le,external:ae,plugin:ue,clean:ce,fullReloads:fe,params:p};exports.alias=le;exports.callback=U;exports.callbackAfterBuild=J;exports.chunkDir=oe;exports.clean=ce;exports.configureBuilder=ne;exports.copy=L;exports.copyGlob=X;exports.css=R;exports.default=Je;exports.external=ae;exports.fileToId=W;exports.fullReloads=fe;exports.getGlobBaseFromPattern=N;exports.isDev=Q;exports.isProd=x;exports.isWindows=F;exports.js=z;exports.link=H;exports.mergeViteConfig=ie;exports.move=V;exports.moveGlob=Y;exports.outDir=re;exports.plugin=ue;exports.shortHash=D;exports.symlink=j;exports.useFusion=se;
//# sourceMappingURL=index.cjs.map
