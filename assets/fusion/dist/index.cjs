"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const $=require("crypto"),h=require("lodash-es"),o=require("node:path"),z=require("node:util"),g=require("vite"),L=require("yargs"),B=require("esbuild"),O=require("module"),m=require("node:fs"),E=require("archy"),y=require("chalk"),j=require("fast-glob"),p=require("fs-extra");function d(t){return Array.isArray(t)?t:[t]}function b(t,e){return Array.isArray(t)?t.map(e):e(t)}function V(t,e,s={}){return new R(t,e,s)}class R{constructor(e,s,i={}){this.input=e,this.output=s,this.options=i}async config(e,s){b(this.input,i=>{const n=s.addTask(i,e);s.assetFileNamesCallbacks.push(r=>{const u=r.names[0];if(u&&o.basename(u,".css")===n.id)return this.output?n.normalizeOutput(this.output,".css"):o.parse(i).name+".css"})})}preview(){return d(this.input).map(e=>({input:e,output:this.output||o.basename(e),extra:{}}))}}function H(t,e){return new G(t,e)}class G{constructor(e,s){this.input=e,this.output=s}config(e,s){b(this.input,i=>{const n=s.addTask(i,e);s.entryFileNamesCallbacks.push(r=>{const u=r.name;if(u&&u===n.id)return this.output?n.normalizeOutput(this.output):o.parse(i).name+".js"})})}preview(){return d(this.input).map(e=>({input:e,output:this.output||o.basename(e),extra:{}}))}}function I(t,e){return new J(t,e)}class J{constructor(e,s){this.input=e,this.dest=s}config(e,s){b(this.input,i=>{s.moveTasks.push({src:i,dest:this.dest,options:{}})})}preview(){return d(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function U(t,e){return new K(t,e)}class K{constructor(e,s){this.input=e,this.dest=s}config(e,s){b(this.input,i=>{s.copyTasks.push({src:i,dest:this.dest,options:{}})})}preview(){return d(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}function Q(t,e,s={}){return new X(t,e,s)}class X{constructor(e,s,i={}){this.input=e,this.dest=s,this.options=i}config(e,s){b(this.input,i=>{s.linkTasks.push({src:i,dest:this.dest,options:this.options})})}preview(){return d(this.input).map(e=>({input:e,output:this.dest,extra:{}}))}}exports.params=void 0;function Y(t){return exports.params=t,exports.isVerbose=exports.params?.verbose?exports.params?.verbose>0:!1,t}exports.isVerbose=!1;const S=process.env.NODE_ENV==="production",Z=!S;function k(){return process.platform==="win32"}function q(t,e=8){let s=$.createHash("sha1").update(t).digest("hex");return e&&e>0&&(s=s.substring(0,e)),s}function A(t,e,s){const i=[];t=x(t,s.outDir),e=x(e,s.outDir);const n=ne(t),r=re(t)?j.globSync(j.convertPathToPattern(t),s.globOptions):[t];for(let u of r){let l,a=e;ie(e)?(l=a,a=a+o.relative(n,u)):l=o.dirname(a),p.ensureDirSync(l),i.push(s.handler(u,a))}return i}function ee(t,e,s){const i=[];for(const{src:n,dest:r,options:u}of t){const l=A(n,r,{outDir:e,handler:async(a,c)=>(s.info(`Moving file from ${o.relative(e,a)} to ${o.relative(e,c)}`),p.move(a,c,{overwrite:!0})),globOptions:{onlyFiles:!0}});i.push(...l)}return Promise.all(i)}function te(t,e,s){const i=[];for(const{src:n,dest:r,options:u}of t){const l=A(n,r,{outDir:e,handler:async(a,c)=>(s.info(`Copy file from ${o.relative(e,a)} to ${o.relative(e,c)}`),p.copy(a,c,{overwrite:!0})),globOptions:{onlyFiles:!0}});i.push(...l)}return Promise.all(i)}function se(t,e,s){const i=[];for(const{src:n,dest:r,options:u}of t){const l=A(n,r,{outDir:e,handler:async(a,c)=>(s.info(`Link file from ${o.relative(e,a)} to ${o.relative(e,c)}`),W(a,c,u?.force??!1)),globOptions:{onlyFiles:!1}});i.push(...l)}return Promise.all(i)}async function W(t,e,s=!1){return k()&&p.lstatSync(t).isDirectory()?p.ensureSymlink(t,e,"junction"):k()&&p.lstatSync(t).isFile()&&s?p.ensureLink(t,e):p.ensureSymlink(t,e)}function ie(t){return t.endsWith("/")||t.endsWith("\\")}function ne(t){const e=["*","?","[","]"],s=[...t].findIndex(i=>e.includes(i));return s===-1?o.dirname(t):o.dirname(t.slice(0,s+1))}function re(t){return["*","?","[","]"].some(s=>t.includes(s))}function x(t,e){return t.startsWith(".")?t=o.resolve(t):o.isAbsolute(t)||(t=e+"/"+t),t}class T{constructor(e,s){this.input=e,this.group=s,this.id=T.toFileId(e,s),this.input=o.normalize(e)}id;output;postCallbacks=[];dest(e){return typeof e=="string"&&(e=this.normalizeOutput(e)),this.output=e,this}addPostCallback(e){return this.postCallbacks.push(e),this}normalizeOutput(e,s=".js"){return(e.endsWith("/")||e.endsWith("\\"))&&(e+=o.parse(this.input).name+s),e}static toFileId(e,s){return e=o.normalize(e),s||=h.uniqueId(),s+"-"+q(e)}}function oe(t,e=10){console.log(z.inspect(t,{depth:e,colors:!0}))}class C{constructor(e,s,i){this.config=e,this.env=s,this.params=i,this.config=g.mergeConfig(this.config,{build:{rollupOptions:{preserveEntrySignatures:"strict",input:{},output:this.getDefaultOutput()},emptyOutDir:!1,sourcemap:s.mode!=="production"?"inline":!1},plugins:[],css:{devSourcemap:!0},esbuild:{target:"es2022"}})}static globalOverrideConfig={};overrideConfig={};entryFileNamesCallbacks=[];chunkFileNamesCallbacks=[];assetFileNamesCallbacks=[];moveTasks=[];copyTasks=[];linkTasks=[];postBuildCallbacks=[];cleans=[];tasks=new Map;merge(e){return typeof e=="function"?(this.config=e(this.config)??this.config,this):(this.config=g.mergeConfig(this.config,e),this)}getDefaultOutput(){return{entryFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const i of this.entryFileNamesCallbacks){const n=i(e);if(n)return n}return"[name].js"},chunkFileNames:e=>{const s=this.getChunkNameFromTask(e);if(s)return s;for(const i of this.chunkFileNamesCallbacks){const n=i(e);if(n)return n}return"chunks/[name]-[hash].js"},assetFileNames:e=>{for(const s of this.assetFileNamesCallbacks){const i=s(e);if(i)return i}return"[name].[ext]"}}}getChunkNameFromTask(e){if(this.tasks.has(e.name)){const s=this.tasks.get(e.name)?.output;if(s){const i=typeof s=="function"?s(e):s;if(!o.isAbsolute(i))return i}}}ensurePath(e,s={}){return h.get(this.config,e)==null&&h.set(this.config,e,s),this}get(e){return h.get(this.config,e)}set(e,s){return h.set(this.config,e,s),this}addTask(e,s){const i=new T(e,s);this.tasks.set(i.id,i);const n=this.config.build.rollupOptions.input;return n[i.id]=i.input,i}addPlugin(e){this.config.plugins?.push(e)}removePlugin(e){this.config.plugins=this.config.plugins?.filter(s=>s?typeof e=="string"&&typeof s=="object"&&"name"in s?s.name!==e:typeof e=="object"&&typeof s=="object"?s!==e:!0:!0)}relativePath(e){return o.relative(process.cwd(),e)}debug(){oe(this.config)}}function ue(t){return t??=process.argv,t.slice(2).join(" ").split(" -- ").slice(1).join(" -- ").trim().split(" ").filter(e=>e!=="")}function ae(t){const e=L();return e.option("cwd",{type:"string",description:"Current working directory"}),e.option("list",{alias:"l",type:"boolean",description:"List all available tasks"}),e.option("config",{alias:"c",type:"string",description:"Path to config file"}),e.option("verbose",{alias:"v",type:"count",description:"Increase verbosity of output. Use multiple times for more verbosity."}),e.parseSync(t)}async function le(t){let e=t.path;if(process.platform==="win32"){const s=e.replace(/\\/g,"/");s.startsWith("file://")||(e=`file:///${s}`)}if(t.ts){const i=(await B.build({entryPoints:[t.path],bundle:!0,write:!1,outdir:"dist",platform:"node",format:"cjs",target:"esnext",external:["../dist","../dist/*"],packages:"external",sourcemap:"inline"})).outputFiles[0],n=Buffer.from(i.contents).toString("utf8");m.writeFileSync(i.path,n);const r=new O(i.path,void 0);return r.filename=i.path,r.paths=O._nodeModulePaths(o.dirname(i.path)),r._compile(n,i.path),w(r.exports)}else{const s=await import(e);return w(s)}}function w(t){return t={...t},t.__esModule&&delete t.__esModule,t}async function P(t,e=!1){return t=await t,!e&&Array.isArray(t)?(await Promise.all(t.map(i=>P(i,!0)))).flat():N(typeof t=="function"?await t():await t,t?.name)}async function N(t,e){if(!Array.isArray(t))return[await t];const s=await Promise.all(t),i=[];for(const n of s)Array.isArray(n)?i.push(...n):i.push(n);return i}function ce(t,e){const s=fe(t,e);if(!s)throw new Error("No config file found. Please create a fusionfile.js or fusionfile.ts in the root directory.");return s}function fe(t,e){let s=e?.config;return s?(o.isAbsolute(s)||(s=o.resolve(t,s)),m.existsSync(s)?{path:s,filename:s.split("/").pop()||"",type:de(s),ts:he(s)}:null):pe(t)}function pe(t){let e=o.resolve(t,"fusionfile.js");return m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"commonjs",ts:!1}:(e=o.resolve(t,"fusionfile.mjs"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!1}:(e=o.resolve(t,"fusionfile.ts"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:(e=o.resolve(t,"fusionfile.mts"),m.existsSync(e)?{path:e,filename:e.split("/").pop()||"",type:"module",ts:!0}:null)))}function de(t){let e="unknown";return t.endsWith(".cjs")?e="commonjs":(t.endsWith(".mjs")||t.endsWith(".ts")||t.endsWith(".mts"))&&(e="module"),e}function he(t){return t.endsWith(".ts")||t.endsWith(".mts")}async function me(t){const e=Object.keys(t);e.sort((n,r)=>n==="default"?-1:r==="default"?1:n.localeCompare(r));const s=[];for(const n of e){const r=t[n];s.push(await _(n,r))}const i=E({label:y.magenta("Available Tasks"),nodes:s});console.log(i)}async function _(t,e){const s=[];e=d(await e);for(let i of e){const n=await P(i,!0);for(const r of n)typeof r=="function"?s.push(await _(r.name,r)):s.push(...await ge(r))}return{label:y.cyan(t),nodes:s}}async function ge(t){const e=await t.preview();return Promise.all(e.map(s=>ye(s)))}async function ye(t){const e=[],{input:s,output:i,extra:n}=t,r=y.yellow(s);e.push(`Input: ${r}`);const u=y.green(i);return e.push(`Output: ${u}`),e.join(" - ")}function be(t,e){t=h.uniq(t),t.length===0&&t.push("default");const s={};for(const i of t)if(e[i])s[i]=e[i];else throw new Error(`Task "${y.cyan(i)}" not found in fusion config.`);return s}async function ve(t){const e={},s={};for(const i in t){const n=t[i];s[i]=await F(i,n,e)}return s}async function F(t,e,s){const i=[];if(Array.isArray(e))for(const n in e){const r=e[n];i.push(...await F(n,r,s))}else if(typeof e=="function"){if(t=e.name||t,s[t])return[];s[t]=e;const n=await P(e,!0);if(Array.isArray(n))for(const r in n){const u=n[r];i.push(...await F(r,u,s))}}else i.push(await e);return i}const f=ae(ue(process.argv));Y(f);exports.builder=void 0;const we=f._;function ke(t={},e){let s;const i=Ce(t);return e!==void 0||Array.isArray(e)&&e.length>0?f._=d(e):f._=we,i.cwd!==void 0&&(f.cwd=i.cwd),[{name:"fusion",configResolved(n){s=n.logger},async config(n,r){let u;n.root?u=o.resolve(n.root):u=f.cwd||process.cwd(),delete n.root,process.chdir(u),exports.builder=new C(n,r,f);let l;if(typeof i.fusionfile=="string"||!i.fusionfile){f.config??=i.fusionfile;const v=ce(u,f);l=await le(v)}else typeof i.fusionfile=="function"?l=w(await i.fusionfile()):l=w(i.fusionfile);if(f.list){await me(l);return}const a=be([...f._],l),c=await ve(a);for(const v in c){const D=c[v];for(const M of D)await M.config(v,exports.builder)}return exports.builder.merge(C.globalOverrideConfig),exports.builder.merge(exports.builder.overrideConfig),Object.keys(exports.builder.config.build.rollupOptions.input)?.length===0&&delete exports.builder.config.build.rollupOptions.input,exports.builder.config}},{name:"fusion:post-handles",async writeBundle(n,r){await ee(exports.builder.moveTasks,n.dir??process.cwd(),s),await te(exports.builder.copyTasks,n.dir??process.cwd(),s),await se(exports.builder.linkTasks,n.dir??process.cwd(),s);for(const u of exports.builder.postBuildCallbacks)await u()}}]}function Ce(t){return typeof t=="string"?{fusionfile:t}:typeof t=="function"?{fusionfile:t}:t}function Fe(t){if(t===null){exports.builder.overrideConfig={};return}exports.builder.overrideConfig=g.mergeConfig(C.globalOverrideConfig,t)}function Ae(t){exports.builder.overrideConfig=g.mergeConfig(exports.builder.overrideConfig,{build:{outDir:t}})}function Te(t,e){exports.builder.overrideConfig=g.mergeConfig(exports.builder.overrideConfig,{resolve:{alias:{[t]:e}}})}function Pe(t,e){const s={};e&&(s[t]=e),exports.builder.overrideConfig=g.mergeConfig(exports.builder.overrideConfig,{build:{rollupOptions:{external:[t],output:{globals:s}}}})}exports.alias=Te;exports.copy=U;exports.css=V;exports.external=Pe;exports.isDev=Z;exports.isProd=S;exports.isWindows=k;exports.js=H;exports.link=Q;exports.mergeViteConfig=Fe;exports.move=I;exports.outDir=Ae;exports.shortHash=q;exports.symlink=W;exports.useFusion=ke;
//# sourceMappingURL=index.cjs.map
